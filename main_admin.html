<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel | Curro Capacity System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
        }

        .container {
            max-width: 1800px;
            margin: 0 auto;
            background: white;
            min-height: 100vh;
        }

        header {
            background: #003c72;
            color: white;
            padding: 25px 40px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        header h1 {
            font-size: 2em;
            font-weight: 600;
        }

        .school-name {
            font-size: 1.2em;
            font-weight: 700;
            color: #f6b242;
            margin-top: 5px;
        }

        .logo {
            font-size: 2.5em;
            font-weight: 700;
            color: #f6b242;
        }

        .nav-bar {
            background: white;
            padding: 15px 40px;
            border-bottom: 3px solid #f6b242;
            display: flex;
            gap: 12px;
            align-items: center;
            flex-wrap: wrap;
        }

        .btn {
            padding: 10px 24px;
            border-radius: 6px;
            font-weight: 600;
            font-size: 0.95em;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
        }

        .btn-primary {
            background: #f6b242;
            color: white;
        }

        .btn-primary:hover {
            background: #d99a2e;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: #003c72;
            color: white;
        }

        .btn-secondary:hover {
            background: #002a54;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }

        .tab-navigation {
            display: flex;
            background: white;
            border-bottom: 2px solid #e0e0e0;
            padding: 0 40px;
        }

        .tab-btn {
            padding: 18px 30px;
            border: none;
            background: none;
            font-size: 1.05em;
            font-weight: 600;
            color: #6c757d;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .tab-btn:hover {
            color: #003c72;
            background: #f8f9fa;
        }

        .tab-btn.active {
            color: #003c72;
            border-bottom-color: #f6b242;
        }

        .tab-content {
            display: none;
            padding: 30px 40px;
        }

        .tab-content.active {
            display: block;
        }

        .workflow-steps {
            display: flex;
            justify-content: center;
            margin-bottom: 30px;
            gap: 20px;
        }

        .workflow-step {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 15px 25px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 2px solid #e0e0e0;
            font-weight: 600;
            color: #6c757d;
            transition: all 0.3s;
        }

        .workflow-step.active {
            background: #fff3cd;
            border-color: #f6b242;
            color: #856404;
        }

        .workflow-step.completed {
            background: #d4edda;
            border-color: #28a745;
            color: #155724;
        }

        .workflow-step .step-number {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: #e0e0e0;
            color: #6c757d;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
        }

        .workflow-step.active .step-number {
            background: #f6b242;
            color: white;
        }

        .workflow-step.completed .step-number {
            background: #28a745;
            color: white;
        }

        .admission-container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .form-card {
            background: white;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 25px;
            border: 2px solid #e0e0e0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .form-card h2 {
            color: #003c72;
            font-size: 1.4em;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 0;
        }

        .form-group label {
            display: block;
            color: #495057;
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 0.95em;
        }

        .form-group label .required {
            color: #dc3545;
            margin-left: 3px;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 1em;
            transition: border-color 0.2s;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #f6b242;
        }

        .form-group input.error,
        .form-group select.error {
            border-color: #dc3545;
        }

        .form-group .helper-text {
            font-size: 0.85em;
            color: #6c757d;
            margin-top: 5px;
        }

        .form-group .error-text {
            font-size: 0.85em;
            color: #dc3545;
            margin-top: 5px;
            display: none;
        }

        .form-group .error-text.show {
            display: block;
        }

        /* Radio Button Styles */
        .radio-group {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-top: 10px;
        }

        .radio-option {
            display: flex;
            align-items: center;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .radio-option:hover {
            border-color: #f6b242;
            background: #fff8e1;
        }

        .radio-option.selected {
            border-color: #f6b242;
            background: #fff3cd;
        }

        .radio-option input[type="radio"] {
            margin-right: 10px;
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .radio-option label {
            cursor: pointer;
            flex: 1;
            font-weight: 600;
            margin: 0 !important;
        }

        /* Subject Groups */
        .subject-groups {
            display: flex;
            flex-direction: column;
            gap: 25px;
        }

        .subject-group {
            background: #f8f9fa;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            padding: 20px;
        }

        .subject-group.mandatory {
            border-color: #dc3545;
            background: #fff5f5;
        }

        .subject-group-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .subject-group-title {
            font-size: 1.2em;
            font-weight: 700;
            color: #003c72;
        }

        .subject-group.mandatory .subject-group-title {
            color: #dc3545;
        }

        .subject-group-badge {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.85em;
            font-weight: 600;
            background: #e0e0e0;
            color: #495057;
        }

        .subject-group.mandatory .subject-group-badge {
            background: #dc3545;
            color: white;
        }

        .subjects-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 12px;
        }

        .subject-checkbox {
            display: flex;
            align-items: center;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            transition: all 0.2s;
            cursor: pointer;
            background: white;
        }

        .subject-checkbox:hover:not(.full):not(.locked) {
            border-color: #f6b242;
            background: #fff8e1;
        }

        .subject-checkbox.selected {
            border-color: #f6b242;
            background: #fff3cd;
        }

        .subject-checkbox.locked {
            border-color: #dc3545;
            background: #fff5f5;
            cursor: default;
        }

        .subject-checkbox.full {
            opacity: 0.6;
            cursor: not-allowed;
            background: #f8f9fa;
        }

        .subject-checkbox input[type="checkbox"] {
            margin-right: 10px;
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .subject-checkbox.locked input[type="checkbox"],
        .subject-checkbox.full input[type="checkbox"] {
            cursor: not-allowed;
        }

        .subject-info {
            flex: 1;
        }

        .subject-name {
            font-weight: 600;
            color: #003c72;
            margin-bottom: 3px;
        }

        .subject-capacity {
            font-size: 0.85em;
            color: #6c757d;
        }

        .subject-capacity.available {
            color: #28a745;
        }

        .subject-capacity.full {
            color: #dc3545;
            font-weight: 600;
        }

        .group-capacity-info {
            font-size: 0.8em;
            color: #856404;
            font-style: italic;
        }

        .result-summary {
            background: white;
            border-radius: 12px;
            padding: 25px;
            border: 2px solid #e0e0e0;
            margin-bottom: 20px;
        }

        .result-summary h3 {
            color: #003c72;
            font-size: 1.2em;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .summary-item {
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            text-align: center;
        }

        .summary-item .label {
            font-size: 0.85em;
            color: #6c757d;
            margin-bottom: 5px;
        }

        .summary-item .value {
            font-size: 1.8em;
            font-weight: 700;
            color: #003c72;
        }

        .reference-number {
            font-family: 'Courier New', monospace;
            font-size: 1.5em;
            font-weight: 700;
            color: #f6b242;
            letter-spacing: 2px;
        }

        .subject-results {
            margin-top: 20px;
        }

        .subject-result-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 15px;
            background: #f8f9fa;
            border-radius: 6px;
            margin-bottom: 8px;
        }

        .subject-result-item.success {
            background: #d4edda;
            border-left: 4px solid #28a745;
        }

        .subject-result-item.error {
            background: #f8d7da;
            border-left: 4px solid #dc3545;
        }

        .subject-result-item.warning {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
        }

        .confirmation-dialog {
            background: white;
            border-radius: 12px;
            padding: 30px;
            border: 2px solid #f6b242;
            margin-bottom: 20px;
        }

        .confirmation-dialog h3 {
            color: #003c72;
            font-size: 1.3em;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .confirmation-details {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .confirmation-details .detail-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #e0e0e0;
        }

        .confirmation-details .detail-row:last-child {
            border-bottom: none;
        }

        .confirmation-details .detail-label {
            font-weight: 600;
            color: #6c757d;
        }

        .confirmation-details .detail-value {
            color: #003c72;
            font-weight: 600;
        }

        .confirmation-actions {
            display: flex;
            gap: 15px;
            justify-content: flex-end;
        }

        .alert {
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 500;
        }

        .alert.success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }

        .alert.error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }

        .alert.warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
        }

        .alert.info {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
        }

        /* Group Management */
        .group-manager {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 25px;
            border: 2px solid #e0e0e0;
        }

        .group-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 20px;
        }

        .group-item {
            background: #f8f9fa;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
        }

        .group-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .group-name {
            font-size: 1.1em;
            font-weight: 700;
            color: #003c72;
        }

        .group-subjects {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .subject-tag {
            padding: 4px 12px;
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 12px;
            font-size: 0.85em;
            color: #495057;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .loading-overlay.show {
            display: flex;
        }

        .loading-content {
            background: white;
            padding: 40px;
            border-radius: 12px;
            text-align: center;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #f6b242;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Capacity Management */
        .capacity-controls {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 25px;
            border: 2px solid #e0e0e0;
        }

        .capacity-controls h3 {
            color: #003c72;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .control-row {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: flex-end;
        }

        .search-box {
            flex: 1;
            min-width: 250px;
        }

        .search-box input {
            width: 100%;
            padding: 10px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 1em;
        }

        .search-box input:focus {
            outline: none;
            border-color: #f6b242;
        }

        .filter-group {
            display: flex;
            gap: 10px;
        }

        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            border: 2px solid #e0e0e0;
            text-align: center;
            transition: all 0.2s;
        }

        .stat-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .stat-card .stat-icon {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .stat-card .stat-value {
            font-size: 2.2em;
            font-weight: 700;
            color: #003c72;
            margin-bottom: 5px;
        }

        .stat-card .stat-label {
            font-size: 0.9em;
            color: #6c757d;
            font-weight: 600;
        }

        .grade-section {
            margin-bottom: 30px;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid #e0e0e0;
        }

        .grade-header {
            background: #003c72;
            color: white;
            padding: 15px 25px;
            font-size: 1.3em;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .grade-actions {
            display: flex;
            gap: 10px;
        }

        .grade-actions button {
            padding: 6px 15px;
            font-size: 0.85em;
        }

        .subjects-table {
            width: 100%;
            border-collapse: collapse;
        }

        .subjects-table thead {
            background: #f8f9fa;
        }

        .subjects-table th {
            padding: 12px 20px;
            text-align: left;
            font-weight: 600;
            color: #003c72;
            font-size: 0.9em;
            border-bottom: 2px solid #f6b242;
        }

        .subjects-table td {
            padding: 12px 20px;
            border-bottom: 1px solid #e9ecef;
        }

        .subjects-table tr:hover {
            background: #f8f9fa;
        }

        .capacity-input {
            width: 100px;
            padding: 6px 10px;
            border: 2px solid #e0e0e0;
            border-radius: 4px;
            text-align: center;
        }

        .capacity-input:focus {
            outline: none;
            border-color: #f6b242;
        }

        .current-count {
            font-size: 1.2em;
            font-weight: 700;
            color: #f6b242;
        }

        .status-badge {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.85em;
            font-weight: 600;
        }

        .status-available { background: #d4edda; color: #155724; }
        .status-full { background: #fff3cd; color: #856404; }
        .status-over { background: #f8d7da; color: #721c24; }

        @media (max-width: 768px) {
            .workflow-steps {
                flex-direction: column;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .subjects-grid {
                grid-template-columns: 1fr;
            }

            .tab-navigation {
                overflow-x: auto;
            }

            .control-row {
                flex-direction: column;
            }

            .search-box {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div>
                <h1>Admin Panel</h1>
                <div class="school-name" id="schoolName">CURRO RIVONIA</div>
            </div>
            <div class="logo">CURRO</div>
        </header>

        <div class="nav-bar">
            <a href="dashboard.html" class="btn btn-primary">üìä View Dashboard</a>
            <button onclick="saveToFirebase()" class="btn btn-secondary">‚òÅÔ∏è Save to Cloud</button>
            <button onclick="loadFromFirebase()" class="btn btn-secondary">üîÑ Reload from Cloud</button>
            <div style="flex: 1;"></div>
            <span style="color: #6c757d; font-size: 0.9em; margin-right: 15px;">üë§ <span id="userEmail">Loading...</span></span>
            <button onclick="signOut()" class="btn btn-danger">üö™ Sign Out</button>
        </div>

        <div class="tab-navigation">
            <button class="tab-btn active" onclick="switchTab('admission')">
                ‚úÖ Student Admission
            </button>
            <button class="tab-btn" onclick="switchTab('capacity')">
                üìä Capacity Management
            </button>
            <button class="tab-btn" onclick="switchTab('groups')">
                üî¢ Subject Groups
            </button>
            <button class="tab-btn" onclick="switchTab('settings')">
                ‚öôÔ∏è Settings
            </button>
        </div>

        <!-- Admission Tab -->
        <div id="admissionTab" class="tab-content active">
            <div class="admission-container">
                <div class="workflow-steps">
                    <div class="workflow-step active" id="step1">
                        <div class="step-number">1</div>
                        <span>Student Details</span>
                    </div>
                    <div class="workflow-step" id="step2">
                        <div class="step-number">2</div>
                        <span>Select Subjects</span>
                    </div>
                    <div class="workflow-step" id="step3">
                        <div class="step-number">3</div>
                        <span>Review & Confirm</span>
                    </div>
                </div>

                <!-- Step 1: Student Details -->
                <div class="form-card" id="studentDetailsCard">
                    <h2>üìù Step 1: Student Information</h2>
                    <div class="form-row">
                        <div class="form-group">
                            <label>
                                Student Full Name 
                                <span class="required">*</span>
                            </label>
                            <input type="text" id="studentName" placeholder="e.g. John Smith" />
                            <div class="error-text" id="nameError">Please enter student's name</div>
                        </div>
                        <div class="form-group">
                            <label>
                                Select Grade 
                                <span class="required">*</span>
                            </label>
                            <select id="admissionGrade" onchange="handleGradeChange()">
                                <option value="">-- Choose Grade --</option>
                                <option value="4">Grade 4</option>
                                <option value="5">Grade 5</option>
                                <option value="6">Grade 6</option>
                                <option value="7">Grade 7</option>
                                <option value="8">Grade 8</option>
                                <option value="9">Grade 9</option>
                                <option value="10">Grade 10</option>
                                <option value="11">Grade 11</option>
                                <option value="12">Grade 12</option>
                            </select>
                            <div class="error-text" id="gradeError">Please select a grade</div>
                        </div>
                    </div>
                    <button onclick="proceedToSubjects()" class="btn btn-primary">
                        Next: Select Subjects ‚Üí
                    </button>
                </div>

                <!-- Step 2: Subject Selection -->
                <div class="form-card" id="subjectSelectionCard" style="display: none;">
                    <h2>üìö Step 2: Subject Selection</h2>
                    <div class="alert info" id="subjectInfo">
                        Select subjects according to grade requirements.
                    </div>
                    <div id="subjectGroups" class="subject-groups">
                        <p style="color: #6c757d; text-align: center;">Complete Step 1 first</p>
                    </div>
                    <div style="display: flex; gap: 15px; margin-top: 20px;">
                        <button onclick="backToDetails()" class="btn btn-secondary">
                            ‚Üê Back
                        </button>
                        <button onclick="reviewAdmission()" class="btn btn-primary" id="reviewBtn">
                            Review Admission ‚Üí
                        </button>
                    </div>
                </div>

                <!-- Step 3: Review & Confirm -->
                <div id="reviewCard" style="display: none;">
                    <div class="result-summary">
                        <h3>‚úÖ Step 3: Review Admission Details</h3>
                        
                        <div class="summary-grid">
                            <div class="summary-item">
                                <div class="label">Reference Number</div>
                                <div class="value reference-number" id="reviewReference">-</div>
                            </div>
                            <div class="summary-item">
                                <div class="label">Student Name</div>
                                <div class="value" id="reviewName" style="font-size: 1.3em;">-</div>
                            </div>
                            <div class="summary-item">
                                <div class="label">Grade</div>
                                <div class="value" id="reviewGrade">-</div>
                            </div>
                            <div class="summary-item">
                                <div class="label">Total Subjects</div>
                                <div class="value" id="reviewTotal">0</div>
                            </div>
                            <div class="summary-item">
                                <div class="label">Status</div>
                                <div class="value" id="reviewStatus" style="font-size: 1.3em;">-</div>
                            </div>
                        </div>

                        <div class="subject-results" id="subjectResults"></div>
                    </div>

                    <div class="confirmation-dialog" id="confirmationDialog" style="display: none;">
                        <h3>‚ö†Ô∏è Confirm Student Admission</h3>
                        <div class="confirmation-details">
                            <div class="detail-row">
                                <span class="detail-label">Reference Number:</span>
                                <span class="detail-value reference-number" id="confirmReference">-</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Action:</span>
                                <span class="detail-value">Add 1 student to selected subjects</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Student:</span>
                                <span class="detail-value" id="confirmName">-</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Grade:</span>
                                <span class="detail-value" id="confirmGrade">-</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Subjects:</span>
                                <span class="detail-value" id="confirmSubjects">-</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Email Notification:</span>
                                <span class="detail-value" id="confirmEmail">-</span>
                            </div>
                        </div>
                        <div class="confirmation-actions">
                            <button onclick="cancelAdmission()" class="btn btn-secondary">
                                ‚Üê Back to Review
                            </button>
                            <button onclick="finalizeAdmission()" class="btn btn-success" id="finalAdmitBtn">
                                ‚úÖ Confirm & Admit Student
                            </button>
                        </div>
                    </div>

                    <div style="display: flex; gap: 15px; margin-top: 20px;" id="reviewActions">
                        <button onclick="backToSubjects()" class="btn btn-secondary">
                            ‚Üê Back to Subjects
                        </button>
                        <button onclick="showConfirmation()" class="btn btn-success" id="proceedAdmitBtn" disabled>
                            Proceed to Admit ‚Üí
                        </button>
                    </div>
                </div>

                <div id="successAlert" style="display: none;"></div>
            </div>
        </div>

        <!-- Capacity Management Tab -->
        <div id="capacityTab" class="tab-content">
            <div class="stats-container" id="statsContainer"></div>
            <div class="capacity-controls">
                <h3>üîç Search & Filter</h3>
                <div class="control-row">
                    <div class="search-box">
                        <input type="text" id="searchSubjects" placeholder="Search subjects..." onkeyup="filterSubjects()">
                    </div>
                    <div class="filter-group">
                        <select id="gradeFilter" onchange="filterSubjects()" style="padding: 10px;">
                            <option value="">All Grades</option>
                            <option value="4">Grade 4</option>
                            <option value="5">Grade 5</option>
                            <option value="6">Grade 6</option>
                            <option value="7">Grade 7</option>
                            <option value="8">Grade 8</option>
                            <option value="9">Grade 9</option>
                            <option value="10">Grade 10</option>
                            <option value="11">Grade 11</option>
                            <option value="12">Grade 12</option>
                        </select>
                        <select id="statusFilter" onchange="filterSubjects()" style="padding: 10px;">
                            <option value="">All Status</option>
                            <option value="available">Available</option>
                            <option value="high">High Capacity</option>
                            <option value="full">Full</option>
                            <option value="over">Over Capacity</option>
                        </select>
                    </div>
                    <button onclick="setDefaultCapacities()" class="btn btn-secondary">
                        Set Defaults (+20%)
                    </button>
                </div>
            </div>
            <div id="capacityManagement"></div>
        </div>

        <!-- Subject Groups Tab -->
        <div id="groupsTab" class="tab-content">
            <div class="form-card">
                <h2>üî¢ Subject Groups Configuration</h2>
                <p style="color: #6c757d; margin-bottom: 20px;">
                    Configure subject groups for Grades 10-12. Students must select one subject from each group.
                </p>
                
                <div class="form-group">
                    <label>Select Grade to Configure</label>
                    <select id="groupConfigGrade" onchange="loadGroupConfiguration()">
                        <option value="">-- Select Grade --</option>
                        <option value="10">Grade 10</option>
                        <option value="11">Grade 11</option>
                        <option value="12">Grade 12</option>
                    </select>
                </div>

                <div id="groupConfiguration" style="display: none;">
                    <!-- Group 1 -->
                    <div class="group-manager">
                        <h3>Group 1 Subjects</h3>
                        <div id="group1Subjects" class="subjects-grid"></div>
                    </div>

                    <!-- Group 2 -->
                    <div class="group-manager">
                        <h3>Group 2 Subjects</h3>
                        <div id="group2Subjects" class="subjects-grid"></div>
                    </div>

                    <!-- Group 3 -->
                    <div class="group-manager">
                        <h3>Group 3 Subjects</h3>
                        <div id="group3Subjects" class="subjects-grid"></div>
                    </div>

                    <button onclick="saveGroupConfiguration()" class="btn btn-success">
                        üíæ Save Group Configuration
                    </button>
                </div>
            </div>
        </div>

        <!-- Settings Tab -->
        <div id="settingsTab" class="tab-content">
            <div class="form-card">
                <h2>üìß Email Notification Settings</h2>
                <div class="form-group">
                    <label>Recipient Email Addresses</label>
                    <textarea id="emailRecipients" placeholder="Enter email addresses (one per line)&#10;example@currorivonia.co.za&#10;admin@currorivonia.co.za" style="width: 100%; padding: 10px 12px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 0.9em; min-height: 150px; font-family: inherit; resize: vertical;"></textarea>
                    <div class="helper-text">Emails will be sent automatically when a student is admitted</div>
                </div>
                <button onclick="saveEmailSettings()" class="btn btn-success">
                    üíæ Save Email Settings
                </button>
            </div>

            <div class="form-card">
                <h2>üì§ Import / Export Data</h2>
                <div class="form-group">
                    <label>Upload CSV Report</label>
                    <input type="file" id="fileInput" accept=".csv" style="display: block; margin-top: 10px;" />
                    <div id="uploadStatus" style="margin-top: 10px;"></div>
                </div>
            </div>

            <div class="form-card">
                <h2>‚ö†Ô∏è Danger Zone</h2>
                <p style="color: #6c757d; margin-bottom: 15px;">These actions cannot be undone. Please be careful.</p>
                <button onclick="clearAllCapacities()" class="btn btn-danger">
                    üóëÔ∏è Clear All Capacity Settings
                </button>
            </div>
        </div>
    </div>

    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-content">
            <div class="spinner"></div>
            <h3 style="color: #003c72;">Processing...</h3>
            <p id="loadingMessage">Please wait</p>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyA5US45QlRkkIgNzvGY8NxOtgxhtBFrVV0",
            authDomain: "db-test-4e542.firebaseapp.com",
            databaseURL: "https://db-test-4e542-default-rtdb.firebaseio.com",
            projectId: "db-test-4e542",
            storageBucket: "db-test-4e542.firebasestorage.app",
            messagingSenderId: "635686299111",
            appId: "1:635686299111:web:44c438ded2deeb87fe0942"
        };

        let database, auth;
        try {
            firebase.initializeApp(firebaseConfig);
            database = firebase.database();
            auth = firebase.auth();
            console.log("‚úÖ Firebase initialized successfully");
        } catch (error) {
            console.error("‚ùå Firebase initialization error:", error);
        }

        auth.onAuthStateChanged((user) => {
            if (!user) {
                window.location.href = 'login.html?redirect=main_admin.html';
            } else {
                document.getElementById('userEmail').textContent = user.email;
            }
        });

        function signOut() {
            if (confirm('Are you sure you want to sign out?')) {
                auth.signOut().then(() => window.location.href = 'login.html');
            }
        }

        // Global variables
        let studentData = [];
        let capacities = {};
        let subjectGroups = {};
        let selectedSubjects = [];
        let selectedLanguage = '';
        let selectedMath = '';
        let selectedGroup1 = '';
        let selectedGroup2 = '';
        let selectedGroup3 = '';
        let emailRecipients = [];
        let currentStep = 1;
        let currentReferenceNumber = '';

        const EMAILJS_PUBLIC_KEY = 'Vw5a0CwDdKhv90Z-N';
        const EMAILJS_SERVICE_ID = 'service_wu805b1';
        const EMAILJS_TEMPLATE_ID = 'template_4dhxbfk';

        if (typeof emailjs !== 'undefined') {
            emailjs.init(EMAILJS_PUBLIC_KEY);
        }

        // Generate reference number
        function generateReferenceNumber() {
            const date = new Date();
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const dateStr = `${year}${month}${day}`;
            
            const letters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
            let randomStr = '';
            for (let i = 0; i < 4; i++) {
                randomStr += letters.charAt(Math.floor(Math.random() * letters.length));
            }
            
            return `${dateStr}-${randomStr}`;
        }

        // Initial CSV data (same as before)
        const initialCSVData = `Brand_Name,Company_Name,Textbox4,Textbox2,Textbox26,Textbox40
Curro,Curro Rivonia,10,Accounting,12,2755
Curro,Curro Rivonia,10,Advanced Programme English,2,2755
Curro,Curro Rivonia,10,Advanced Programme Mathematics,9,2755
Curro,Curro Rivonia,10,Afrikaans First Additional Language,47,2755
Curro,Curro Rivonia,10,Business Studies,45,2755
Curro,Curro Rivonia,10,Computer Applications Technology,29,2755
Curro,Curro Rivonia,10,Engineering Graphics and Design,16,2755
Curro,Curro Rivonia,10,English Home Language,70,2755
Curro,Curro Rivonia,10,History,25,2755
Curro,Curro Rivonia,10,Information Technology,19,2755
Curro,Curro Rivonia,10,isiZulu First Additional Language,18,2755
Curro,Curro Rivonia,10,Life Orientation,70,2755
Curro,Curro Rivonia,10,Life Sciences,24,2755
Curro,Curro Rivonia,10,Mathematical Literacy,34,2755
Curro,Curro Rivonia,10,Mathematics,50,2755
Curro,Curro Rivonia,10,Physical Sciences,33,2755
Curro,Curro Rivonia,10,Tourism,23,2755
Curro,Curro Rivonia,10,Visual Arts,12,2755
Curro,Curro Rivonia,11,Accounting,13,2755
Curro,Curro Rivonia,11,Advanced Programme English,4,2755
Curro,Curro Rivonia,11,Advanced Programme Mathematics,7,2755
Curro,Curro Rivonia,11,Afrikaans First Additional Language,51,2755
Curro,Curro Rivonia,11,Business Studies,36,2755
Curro,Curro Rivonia,11,Computer Applications Technology,14,2755
Curro,Curro Rivonia,11,Economics,3,2755
Curro,Curro Rivonia,11,Engineering Graphics and Design,15,2755
Curro,Curro Rivonia,11,English Home Language,69,2755
Curro,Curro Rivonia,11,Geography,3,2755
Curro,Curro Rivonia,11,History,34,2755
Curro,Curro Rivonia,11,Information Technology,10,2755
Curro,Curro Rivonia,11,isiZulu First Additional Language,17,2755
Curro,Curro Rivonia,11,Life Orientation,69,2755
Curro,Curro Rivonia,11,Life Sciences,30,2755
Curro,Curro Rivonia,11,Mathematical Literacy,30,2755
Curro,Curro Rivonia,11,Mathematics,44,2755
Curro,Curro Rivonia,11,Physical Sciences,27,2755
Curro,Curro Rivonia,11,Tourism,33,2755
Curro,Curro Rivonia,11,Visual Arts,5,2755
Curro,Curro Rivonia,12,Accounting,9,2755
Curro,Curro Rivonia,12,Advanced Programme Mathematics,2,2755
Curro,Curro Rivonia,12,Afrikaans First Additional Language,44,2755
Curro,Curro Rivonia,12,Business Studies,31,2755
Curro,Curro Rivonia,12,Computer Applications Technology,16,2755
Curro,Curro Rivonia,12,Economics,7,2755
Curro,Curro Rivonia,12,Engineering Graphics and Design,13,2755
Curro,Curro Rivonia,12,English Home Language,65,2755
Curro,Curro Rivonia,12,French Second Additional Language,2,2755
Curro,Curro Rivonia,12,Geography,8,2755
Curro,Curro Rivonia,12,History,30,2755
Curro,Curro Rivonia,12,Information Technology,5,2755
Curro,Curro Rivonia,12,isiZulu First Additional Language,15,2755
Curro,Curro Rivonia,12,Life Orientation,64,2755
Curro,Curro Rivonia,12,Life Sciences,27,2755
Curro,Curro Rivonia,12,Mathematical Literacy,37,2755
Curro,Curro Rivonia,12,Mathematics,35,2755
Curro,Curro Rivonia,12,Physical Sciences,18,2755
Curro,Curro Rivonia,12,Portuguese Second Additional Language,1,2755
Curro,Curro Rivonia,12,Tourism,19,2755
Curro,Curro Rivonia,12,Visual Arts,13,2755
Curro,Curro Rivonia,8,Afrikaans First Additional Language,59,2755
Curro,Curro Rivonia,8,Business Studies,74,2755
Curro,Curro Rivonia,8,Coding and Robotics ,74,2755
Curro,Curro Rivonia,8,Creative Arts,74,2755
Curro,Curro Rivonia,8,English Home Language,74,2755
Curro,Curro Rivonia,8,isiZulu First Additional Language,15,2755
Curro,Curro Rivonia,8,Life Orientation,74,2755
Curro,Curro Rivonia,8,Mathematics,74,2755
Curro,Curro Rivonia,8,Natural Sciences,74,2755
Curro,Curro Rivonia,8,Social Sciences,74,2755
Curro,Curro Rivonia,9,Accounting,64,2755
Curro,Curro Rivonia,9,Afrikaans First Additional Language,45,2755
Curro,Curro Rivonia,9,Coding and Robotics ,64,2755
Curro,Curro Rivonia,9,Creative Arts,64,2755
Curro,Curro Rivonia,9,English Home Language,64,2755
Curro,Curro Rivonia,9,isiZulu First Additional Language,19,2755
Curro,Curro Rivonia,9,Life Orientation,64,2755
Curro,Curro Rivonia,9,Mathematics,64,2755
Curro,Curro Rivonia,9,Natural Sciences,64,2755
Curro,Curro Rivonia,9,Social Sciences,64,2755`;

        window.addEventListener('DOMContentLoaded', () => {
            console.log("üöÄ Page loaded, initializing...");
            console.log("üìÑ Parsing initial CSV data...");
            parseCSV(initialCSVData);
            console.log(`‚úÖ Parsed ${studentData.length} records from CSV`);
            console.log("‚òÅÔ∏è Loading data from Firebase (will override CSV if exists)...");
            loadFromFirebase();
        });

        document.getElementById('fileInput').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                showLoading('Uploading CSV file...');
                const reader = new FileReader();
                reader.onload = (event) => {
                    parseCSV(event.target.result);
                    document.getElementById('uploadStatus').innerHTML = `<div class="alert success">‚úì Loaded: ${file.name}</div>`;
                    saveToFirebase();
                    renderCapacityManagement();
                    hideLoading();
                };
                reader.readAsText(file);
            }
        });

        function parseCSV(text) {
            const lines = text.trim().split('\n');
            studentData = [];
            
            for (let i = 1; i < lines.length; i++) {
                if (lines[i].trim()) {
                    const parts = lines[i].split(',');
                    if (parts.length >= 6) {
                        studentData.push({
                            brand: parts[0].trim(),
                            school: parts[1].trim(),
                            grade: parseInt(parts[2]),
                            subject: parts[3].trim(),
                            count: parseInt(parts[4]),
                            key: `${parts[2]}-${parts[3].trim()}`
                        });
                    }
                }
            }

            if (studentData.length > 0) {
                document.getElementById('schoolName').textContent = studentData[0].school.toUpperCase();
            }
        }

        async function saveToFirebase() {
            if (!database) {
                console.error("‚ùå Database not initialized");
                return;
            }

            try {
                console.log("üíæ Saving to Firebase...");
                showLoading('Saving to cloud...');
                
                await database.ref('studentData').set(studentData);
                console.log(`‚úÖ Saved ${studentData.length} student records`);
                
                await database.ref('capacities').set(capacities);
                console.log(`‚úÖ Saved ${Object.keys(capacities).length} capacity settings`);
                
                await database.ref('subjectGroups').set(subjectGroups);
                console.log("‚úÖ Saved subject groups");
                
                await database.ref('emailRecipients').set(emailRecipients);
                console.log(`‚úÖ Saved ${emailRecipients.length} email recipients`);
                
                hideLoading();
                showAlert('success', '‚úÖ Data saved to cloud successfully!');
                console.log("‚úÖ Firebase save complete");
            } catch (error) {
                console.error("‚ùå Error saving to Firebase:", error);
                hideLoading();
                showAlert('error', '‚ùå Error saving to cloud: ' + error.message);
            }
        }

        async function loadFromFirebase() {
            if (!database) {
                console.error("‚ùå Database not initialized");
                return;
            }

            try {
                console.log("üîÑ Starting Firebase data load...");
                showLoading('Loading data from cloud...');
                
                const [dataSnap, capSnap, groupsSnap, emailSnap] = await Promise.all([
                    database.ref('studentData').once('value'),
                    database.ref('capacities').once('value'),
                    database.ref('subjectGroups').once('value'),
                    database.ref('emailRecipients').once('value')
                ]);
                
                console.log("üì¶ Snapshots received:", {
                    studentData: dataSnap.exists(),
                    capacities: capSnap.exists(),
                    subjectGroups: groupsSnap.exists(),
                    emailRecipients: emailSnap.exists()
                });
                
                if (dataSnap.exists()) {
                    studentData = dataSnap.val();
                    console.log(`‚úÖ Loaded ${studentData.length} student records`);
                } else {
                    console.log("‚ö†Ô∏è No student data in Firebase, using initial CSV data");
                }
                
                if (capSnap.exists()) {
                    capacities = capSnap.val();
                    console.log(`‚úÖ Loaded ${Object.keys(capacities).length} capacity settings`);
                } else {
                    console.log("‚ö†Ô∏è No capacities in Firebase");
                }
                
                if (groupsSnap.exists()) {
                    subjectGroups = groupsSnap.val();
                    console.log("‚úÖ Loaded subject groups");
                } else {
                    console.log("‚ö†Ô∏è No subject groups in Firebase");
                }
                
                if (emailSnap.exists()) {
                    emailRecipients = emailSnap.val();
                    document.getElementById('emailRecipients').value = emailRecipients.join('\n');
                    console.log(`‚úÖ Loaded ${emailRecipients.length} email recipients`);
                } else {
                    console.log("‚ö†Ô∏è No email recipients in Firebase");
                }

                renderCapacityManagement();
                updateStats();
                hideLoading();
                console.log("‚úÖ Firebase data load complete");
            } catch (error) {
                console.error("‚ùå Error loading from Firebase:", error);
                hideLoading();
                showAlert('error', '‚ùå Failed to load data from Firebase. Check console for details.');
            }
        }

        // Tab switching
        function switchTab(tabName) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');

            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            if (tabName === 'admission') {
                document.getElementById('admissionTab').classList.add('active');
            } else if (tabName === 'capacity') {
                document.getElementById('capacityTab').classList.add('active');
                updateStats();
            } else if (tabName === 'groups') {
                document.getElementById('groupsTab').classList.add('active');
            } else if (tabName === 'settings') {
                document.getElementById('settingsTab').classList.add('active');
            }
        }

        // Workflow management
        function updateWorkflowSteps(step) {
            currentStep = step;
            
            for (let i = 1; i <= 3; i++) {
                const stepEl = document.getElementById(`step${i}`);
                stepEl.classList.remove('active', 'completed');
                
                if (i < step) {
                    stepEl.classList.add('completed');
                } else if (i === step) {
                    stepEl.classList.add('active');
                }
            }
        }

        function proceedToSubjects() {
            const name = document.getElementById('studentName').value.trim();
            const grade = document.getElementById('admissionGrade').value;
            
            let hasError = false;
            
            if (!name) {
                document.getElementById('studentName').classList.add('error');
                document.getElementById('nameError').classList.add('show');
                hasError = true;
            } else {
                document.getElementById('studentName').classList.remove('error');
                document.getElementById('nameError').classList.remove('show');
            }
            
            if (!grade) {
                document.getElementById('admissionGrade').classList.add('error');
                document.getElementById('gradeError').classList.add('show');
                hasError = true;
            } else {
                document.getElementById('admissionGrade').classList.remove('error');
                document.getElementById('gradeError').classList.remove('show');
            }
            
            if (hasError) return;
            
            // Generate reference number
            currentReferenceNumber = generateReferenceNumber();
            
            document.getElementById('studentDetailsCard').style.display = 'none';
            document.getElementById('subjectSelectionCard').style.display = 'block';
            updateWorkflowSteps(2);
            
            loadSubjectsForGrade();
        }

        function backToDetails() {
            document.getElementById('subjectSelectionCard').style.display = 'none';
            document.getElementById('studentDetailsCard').style.display = 'block';
            updateWorkflowSteps(1);
        }

        function handleGradeChange() {
            // Reset selections
            selectedSubjects = [];
            selectedLanguage = '';
            selectedMath = '';
            selectedGroup1 = '';
            selectedGroup2 = '';
            selectedGroup3 = '';
        }

        // Load subjects based on grade
        function loadSubjectsForGrade() {
            const grade = parseInt(document.getElementById('admissionGrade').value);
            const groupsDiv = document.getElementById('subjectGroups');
            
            if (!grade) {
                groupsDiv.innerHTML = '<p style="color: #6c757d; text-align: center;">Select a grade first</p>';
                return;
            }

            const gradeSubjects = studentData.filter(s => s.grade === grade);
            
            if (grade >= 4 && grade <= 9) {
                // Grades 4-9: Auto-select all except languages
                loadGrade4to9Subjects(gradeSubjects);
            } else if (grade >= 10 && grade <= 12) {
                // Grades 10-12: Group-based selection
                loadGrade10to12Subjects(gradeSubjects, grade);
            }
        }

        function loadGrade4to9Subjects(gradeSubjects) {
            const groupsDiv = document.getElementById('subjectGroups');
            const infoDiv = document.getElementById('subjectInfo');
            
            infoDiv.innerHTML = 'Most subjects are automatically selected. Please choose ONE language: Afrikaans, isiZulu, or Exemption.';
            
            let html = '';
            
            // Language Choice Group
            html += `
                <div class="subject-group mandatory">
                    <div class="subject-group-header">
                        <div class="subject-group-title">Language Choice (Choose ONE)</div>
                        <div class="subject-group-badge">REQUIRED</div>
                    </div>
                    <div class="radio-group">
            `;
            
            ['Afrikaans First Additional Language', 'isiZulu First Additional Language', 'Language Exemption'].forEach(lang => {
                const isExemption = lang === 'Language Exemption';
                const subject = isExemption ? null : gradeSubjects.find(s => s.subject === lang);
                const capacity = isExemption ? 999 : (capacities[subject?.key] || 0);
                const count = isExemption ? 0 : (subject?.count || 0);
                const isFull = !isExemption && capacity > 0 && count >= capacity;
                
                html += `
                    <label class="radio-option ${isFull ? 'full' : ''}" onclick="selectLanguage('${lang}', ${isFull})">
                        <input type="radio" name="language" value="${lang}" ${isFull ? 'disabled' : ''}>
                        <span>${lang}</span>
                        <span class="subject-capacity ${isFull ? 'full' : 'available'}">
                            ${isExemption ? 'Always available' : (isFull ? 'FULL' : `${capacity - count} available`)}
                        </span>
                    </label>
                `;
            });
            
            html += `
                    </div>
                </div>
            `;
            
            // Auto-selected subjects
            html += `
                <div class="subject-group locked">
                    <div class="subject-group-header">
                        <div class="subject-group-title">Automatically Selected Subjects</div>
                        <div class="subject-group-badge" style="background: #28a745;">AUTO-SELECTED</div>
                    </div>
                    <div class="subjects-grid">
            `;
            
            gradeSubjects.forEach(subject => {
                if (!subject.subject.includes('Afrikaans') && !subject.subject.includes('isiZulu')) {
                    const capacity = capacities[subject.key] || 0;
                    const available = capacity > 0 ? capacity - subject.count : 0;
                    const isFull = capacity > 0 && subject.count >= capacity;
                    
                    html += `
                        <div class="subject-checkbox locked">
                            <input type="checkbox" checked disabled>
                            <div class="subject-info">
                                <div class="subject-name">${subject.subject}</div>
                                <div class="subject-capacity ${isFull ? 'full' : 'available'}">
                                    ${isFull ? 'At capacity' : (capacity > 0 ? `${available} available` : 'No limit')}
                                </div>
                            </div>
                        </div>
                    `;
                    
                    // Auto-add to selected subjects
                    if (!selectedSubjects.includes(subject.key)) {
                        selectedSubjects.push(subject.key);
                    }
                }
            });
            
            html += `
                    </div>
                </div>
            `;
            
            groupsDiv.innerHTML = html;
        }

        function selectLanguage(lang, isFull) {
            if (isFull) return;
            
            selectedLanguage = lang;
            
            // Update UI
            document.querySelectorAll('.radio-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            event.currentTarget.classList.add('selected');
            
            // Update selected subjects
            const grade = parseInt(document.getElementById('admissionGrade').value);
            const afrikaansSubject = studentData.find(s => s.grade === grade && s.subject === 'Afrikaans First Additional Language');
            const zulu Subject = studentData.find(s => s.grade === grade && s.subject === 'isiZulu First Additional Language');
            
            // Remove any existing language subjects
            selectedSubjects = selectedSubjects.filter(key => {
                return !key.includes('Afrikaans') && !key.includes('isiZulu');
            });
            
            // Add selected language if not exemption
            if (lang !== 'Language Exemption') {
                const subject = lang.includes('Afrikaans') ? afrikaansSubject : zuluSubject;
                if (subject) {
                    selectedSubjects.push(subject.key);
                }
            }
        }

        function loadGrade10to12Subjects(gradeSubjects, grade) {
            const groupsDiv = document.getElementById('subjectGroups');
            const infoDiv = document.getElementById('subjectInfo');
            const groups = subjectGroups[grade] || { group1: [], group2: [], group3: [] };
            
            infoDiv.innerHTML = 'English and Life Orientation are mandatory. Choose Mathematics OR Math Literacy, a language, and ONE subject from each of the three groups.';
            
            let html = '';
            
            // Mandatory Subjects
            html += `
                <div class="subject-group mandatory">
                    <div class="subject-group-header">
                        <div class="subject-group-title">Mandatory Subjects</div>
                        <div class="subject-group-badge">REQUIRED</div>
                    </div>
                    <div class="subjects-grid">
            `;
            
            ['English Home Language', 'Life Orientation'].forEach(subName => {
                const subject = gradeSubjects.find(s => s.subject === subName);
                if (subject) {
                    const capacity = capacities[subject.key] || 0;
                    const available = capacity > 0 ? capacity - subject.count : 0;
                    
                    html += `
                        <div class="subject-checkbox locked">
                            <input type="checkbox" checked disabled>
                            <div class="subject-info">
                                <div class="subject-name">${subject.subject}</div>
                                <div class="subject-capacity available">${capacity > 0 ? `${available} available` : 'No limit'}</div>
                            </div>
                        </div>
                    `;
                    
                    if (!selectedSubjects.includes(subject.key)) {
                        selectedSubjects.push(subject.key);
                    }
                }
            });
            
            html += `
                    </div>
                </div>
            `;
            
            // Math Choice
            html += `
                <div class="subject-group">
                    <div class="subject-group-header">
                        <div class="subject-group-title">Mathematics Choice (Choose ONE)</div>
                        <div class="subject-group-badge">REQUIRED</div>
                    </div>
                    <div class="radio-group">
            `;
            
            ['Mathematics', 'Mathematical Literacy'].forEach(mathSub => {
                const subject = gradeSubjects.find(s => s.subject === mathSub);
                if (subject) {
                    const capacity = capacities[subject.key] || 0;
                    const count = subject.count;
                    const isFull = capacity > 0 && count >= capacity;
                    
                    html += `
                        <label class="radio-option ${isFull ? 'full' : ''}" onclick="selectMath('${subject.key}', ${isFull})">
                            <input type="radio" name="math" value="${subject.key}" ${isFull ? 'disabled' : ''}>
                            <span>${subject.subject}</span>
                            <span class="subject-capacity ${isFull ? 'full' : 'available'}">
                                ${isFull ? 'FULL' : `${capacity - count} available`}
                            </span>
                        </label>
                    `;
                }
            });
            
            html += `
                    </div>
                </div>
            `;
            
            // Language Choice
            html += `
                <div class="subject-group">
                    <div class="subject-group-header">
                        <div class="subject-group-title">Language Choice (Choose ONE)</div>
                        <div class="subject-group-badge">REQUIRED</div>
                    </div>
                    <div class="radio-group">
            `;
            
            ['Afrikaans First Additional Language', 'isiZulu First Additional Language', 'Language Exemption'].forEach(lang => {
                const isExemption = lang === 'Language Exemption';
                const subject = isExemption ? null : gradeSubjects.find(s => s.subject === lang);
                const capacity = isExemption ? 999 : (capacities[subject?.key] || 0);
                const count = isExemption ? 0 : (subject?.count || 0);
                const isFull = !isExemption && capacity > 0 && count >= capacity;
                
                html += `
                    <label class="radio-option ${isFull ? 'full' : ''}" onclick="selectLanguageGrade10to12('${lang}', ${isFull})">
                        <input type="radio" name="language10to12" value="${lang}" ${isFull ? 'disabled' : ''}>
                        <span>${lang}</span>
                        <span class="subject-capacity ${isFull ? 'full' : 'available'}">
                            ${isExemption ? 'Always available' : (isFull ? 'FULL' : `${capacity - count} available`)}
                        </span>
                    </label>
                `;
            });
            
            html += `
                    </div>
                </div>
            `;
            
            // Subject Groups 1, 2, 3
            for (let i = 1; i <= 3; i++) {
                html += `
                    <div class="subject-group">
                        <div class="subject-group-header">
                            <div class="subject-group-title">Group ${i} (Choose ONE)</div>
                            <div class="subject-group-badge">REQUIRED</div>
                        </div>
                        <div class="radio-group">
                `;
                
                const groupKey = `group${i}`;
                const groupSubjects = groups[groupKey] || [];
                
                groupSubjects.forEach(subName => {
                    const subject = gradeSubjects.find(s => s.subject === subName);
                    if (subject) {
                        const capacity = capacities[subject.key] || 0;
                        const count = subject.count;
                        const isFull = capacity > 0 && count >= capacity;
                        
                        html += `
                            <label class="radio-option ${isFull ? 'full' : ''}" onclick="selectGroup${i}('${subject.key}', ${isFull})">
                                <input type="radio" name="group${i}" value="${subject.key}" ${isFull ? 'disabled' : ''}>
                                <span>${subject.subject}</span>
                                <span class="subject-capacity ${isFull ? 'full' : 'available'}">
                                    ${isFull ? 'FULL' : `${capacity - count} available`}
                                </span>
                            </label>
                        `;
                    }
                });
                
                html += `
                        </div>
                    </div>
                `;
            }
            
            groupsDiv.innerHTML = html;
        }

        function selectMath(key, isFull) {
            if (isFull) return;
            
            // Remove previous math selection
            selectedSubjects = selectedSubjects.filter(k => !k.includes('Mathematics') && !k.includes('Mathematical Literacy'));
            selectedMath = key;
            selectedSubjects.push(key);
            
            // Update UI
            document.querySelectorAll('input[name="math"]').forEach(radio => {
                radio.parentElement.classList.remove('selected');
            });
            event.currentTarget.classList.add('selected');
        }

        function selectLanguageGrade10to12(lang, isFull) {
            if (isFull) return;
            
            const grade = parseInt(document.getElementById('admissionGrade').value);
            
            // Remove previous language selection
            selectedSubjects = selectedSubjects.filter(key => {
                return !key.includes('Afrikaans') && !key.includes('isiZulu');
            });
            
            selectedLanguage = lang;
            
            // Add to selected if not exemption
            if (lang !== 'Language Exemption') {
                const subject = studentData.find(s => s.grade === grade && s.subject === lang);
                if (subject) {
                    selectedSubjects.push(subject.key);
                }
            }
            
            // Update UI
            document.querySelectorAll('input[name="language10to12"]').forEach(radio => {
                radio.parentElement.classList.remove('selected');
            });
            event.currentTarget.classList.add('selected');
        }

        function selectGroup1(key, isFull) {
            if (isFull) return;
            
            // Remove previous group1 selection
            if (selectedGroup1) {
                selectedSubjects = selectedSubjects.filter(k => k !== selectedGroup1);
            }
            
            selectedGroup1 = key;
            selectedSubjects.push(key);
            
            // Update UI
            document.querySelectorAll('input[name="group1"]').forEach(radio => {
                radio.parentElement.classList.remove('selected');
            });
            event.currentTarget.classList.add('selected');
        }

        function selectGroup2(key, isFull) {
            if (isFull) return;
            
            if (selectedGroup2) {
                selectedSubjects = selectedSubjects.filter(k => k !== selectedGroup2);
            }
            
            selectedGroup2 = key;
            selectedSubjects.push(key);
            
            document.querySelectorAll('input[name="group2"]').forEach(radio => {
                radio.parentElement.classList.remove('selected');
            });
            event.currentTarget.classList.add('selected');
        }

        function selectGroup3(key, isFull) {
            if (isFull) return;
            
            if (selectedGroup3) {
                selectedSubjects = selectedSubjects.filter(k => k !== selectedGroup3);
            }
            
            selectedGroup3 = key;
            selectedSubjects.push(key);
            
            document.querySelectorAll('input[name="group3"]').forEach(radio => {
                radio.parentElement.classList.remove('selected');
            });
            event.currentTarget.classList.add('selected');
        }

        function reviewAdmission() {
            const grade = parseInt(document.getElementById('admissionGrade').value);
            
            // Validate selections
            if (grade >= 4 && grade <= 9) {
                if (!selectedLanguage) {
                    showAlert('error', 'Please select a language: Afrikaans, isiZulu, or Exemption');
                    return;
                }
            } else if (grade >= 10 && grade <= 12) {
                if (!selectedMath) {
                    showAlert('error', 'Please select Mathematics or Mathematical Literacy');
                    return;
                }
                if (!selectedLanguage) {
                    showAlert('error', 'Please select a language');
                    return;
                }
                if (!selectedGroup1 || !selectedGroup2 || !selectedGroup3) {
                    showAlert('error', 'Please select ONE subject from each of the three groups');
                    return;
                }
            }
            
            // Show review
            document.getElementById('subjectSelectionCard').style.display = 'none';
            document.getElementById('reviewCard').style.display = 'block';
            updateWorkflowSteps(3);
            
            // Populate review details
            const name = document.getElementById('studentName').value;
            
            document.getElementById('reviewReference').textContent = currentReferenceNumber;
            document.getElementById('reviewName').textContent = name;
            document.getElementById('reviewGrade').textContent = `Grade ${grade}`;
            document.getElementById('reviewTotal').textContent = selectedSubjects.length;
            
            // Check capacity
            let canAdmit = true;
            let fullSubjects = [];
            let resultsHtml = '';
            
            selectedSubjects.forEach(key => {
                const subject = studentData.find(s => s.key === key);
                const capacity = capacities[key] || 0;
                
                let resultClass = 'success';
                let icon = '‚úÖ';
                let message = '';
                
                if (capacity === 0) {
                    resultClass = 'warning';
                    icon = '‚ö†Ô∏è';
                    message = `${subject.subject} - No capacity set`;
                } else if (subject.count >= capacity) {
                    canAdmit = false;
                    fullSubjects.push(subject.subject);
                    resultClass = 'error';
                    icon = '‚ùå';
                    message = `${subject.subject} - FULL (${subject.count}/${capacity})`;
                } else {
                    const available = capacity - subject.count;
                    message = `${subject.subject} - ${available} space${available > 1 ? 's' : ''} available`;
                }
                
                resultsHtml += `
                    <div class="subject-result-item ${resultClass}">
                        <span>${icon} ${message}</span>
                    </div>
                `;
            });
            
            document.getElementById('subjectResults').innerHTML = resultsHtml;
            
            const statusEl = document.getElementById('reviewStatus');
            const proceedBtn = document.getElementById('proceedAdmitBtn');
            
            if (canAdmit && fullSubjects.length === 0) {
                statusEl.textContent = '‚úÖ CAN ADMIT';
                statusEl.style.color = '#28a745';
                proceedBtn.disabled = false;
            } else {
                statusEl.textContent = '‚ùå CANNOT ADMIT';
                statusEl.style.color = '#dc3545';
                proceedBtn.disabled = true;
            }
        }

        function backToSubjects() {
            document.getElementById('reviewCard').style.display = 'none';
            document.getElementById('subjectSelectionCard').style.display = 'block';
            updateWorkflowSteps(2);
        }

        function showConfirmation() {
            document.getElementById('reviewActions').style.display = 'none';
            document.getElementById('confirmationDialog').style.display = 'block';
            
            const name = document.getElementById('studentName').value;
            const grade = document.getElementById('admissionGrade').value;
            
            document.getElementById('confirmReference').textContent = currentReferenceNumber;
            document.getElementById('confirmName').textContent = name;
            document.getElementById('confirmGrade').textContent = `Grade ${grade}`;
            document.getElementById('confirmSubjects').textContent = selectedSubjects.length;
            
            const emailCount = emailRecipients.length;
            document.getElementById('confirmEmail').textContent = emailCount > 0 
                ? `${emailCount} recipient(s) will be notified`
                : 'No email notifications configured';
        }

        function cancelAdmission() {
            document.getElementById('confirmationDialog').style.display = 'none';
            document.getElementById('reviewActions').style.display = 'flex';
        }

        async function finalizeAdmission() {
            const name = document.getElementById('studentName').value;
            const grade = document.getElementById('admissionGrade').value;
            
            showLoading('Admitting student and updating records...');
            document.getElementById('finalAdmitBtn').disabled = true;
            
            try {
                // Update counts
                selectedSubjects.forEach(key => {
                    const subject = studentData.find(s => s.key === key);
                    if (subject) {
                        subject.count++;
                    }
                });
                
                // Save to Firebase
                await saveToFirebase();
                
                // Send email
                let emailStatus = '';
                if (emailRecipients.length > 0) {
                    const emailSent = await sendAdmissionEmail(name, grade, selectedSubjects, currentReferenceNumber);
                    if (emailSent) {
                        emailStatus = `<br><br>üìß Email notifications sent to ${emailRecipients.length} recipient(s)`;
                    } else {
                        emailStatus = '<br><br>‚ö†Ô∏è Email notification failed (check console)';
                    }
                }
                
                hideLoading();
                
                // Show success message
                const successHtml = `
                    <div class="alert success">
                        <span style="font-size: 2em;">‚úÖ</span>
                        <div>
                            <strong>${name} successfully admitted to Grade ${grade}!</strong><br>
                            Reference Number: <span class="reference-number">${currentReferenceNumber}</span><br>
                            ${selectedSubjects.length} subject(s) updated and saved to cloud.
                            ${emailStatus}
                        </div>
                    </div>
                `;
                
                document.getElementById('successAlert').innerHTML = successHtml;
                document.getElementById('successAlert').style.display = 'block';
                
                document.getElementById('reviewCard').style.display = 'none';
                
                setTimeout(() => {
                    resetAdmissionForm();
                }, 5000);
                
            } catch (error) {
                hideLoading();
                showAlert('error', 'Error admitting student: ' + error.message);
                document.getElementById('finalAdmitBtn').disabled = false;
            }
        }

        function resetAdmissionForm() {
            document.getElementById('studentName').value = '';
            document.getElementById('admissionGrade').value = '';
            
            selectedSubjects = [];
            selectedLanguage = '';
            selectedMath = '';
            selectedGroup1 = '';
            selectedGroup2 = '';
            selectedGroup3 = '';
            currentReferenceNumber = '';
            
            document.getElementById('successAlert').style.display = 'none';
            document.getElementById('studentDetailsCard').style.display = 'block';
            document.getElementById('finalAdmitBtn').disabled = false;
            
            updateWorkflowSteps(1);
        }

        async function sendAdmissionEmail(studentName, grade, subjects, refNumber) {
            if (emailRecipients.length === 0) return false;

            try {
                const subjectNames = subjects.map(key => {
                    const subject = studentData.find(s => s.key === key);
                    return subject ? subject.subject : key;
                });

                for (const recipient of emailRecipients) {
                    const templateParams = {
                        to_email: recipient,
                        reference_number: refNumber,
                        student_name: studentName,
                        grade: grade,
                        subjects: subjectNames.join(', '),
                        subject_list: subjectNames.map(s => `‚Ä¢ ${s}`).join('\n'),
                        date: new Date().toLocaleString('en-ZA', { 
                            year: 'numeric', 
                            month: 'long', 
                            day: 'numeric',
                            hour: '2-digit',
                            minute: '2-digit'
                        })
                    };

                    await emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_ID, templateParams);
                }

                return true;
            } catch (error) {
                console.error('Error sending email:', error);
                return false;
            }
        }

        function saveEmailSettings() {
            const emailText = document.getElementById('emailRecipients').value;
            emailRecipients = emailText.split('\n')
                .map(email => email.trim())
                .filter(email => email.length > 0 && email.includes('@'));
            
            saveToFirebase();
            showAlert('success', `‚úÖ Email settings saved! ${emailRecipients.length} recipient(s) configured.`);
        }

        // Subject Groups Management
        function loadGroupConfiguration() {
            const grade = document.getElementById('groupConfigGrade').value;
            if (!grade) {
                document.getElementById('groupConfiguration').style.display = 'none';
                return;
            }

            document.getElementById('groupConfiguration').style.display = 'block';
            
            // Load current configuration
            const gradeGroups = subjectGroups[grade] || { group1: [], group2: [], group3: [] };
            const gradeSubjects = studentData.filter(s => s.grade === parseInt(grade));
            
            // Render each group
            for (let i = 1; i <= 3; i++) {
                renderGroupSubjects(i, gradeSubjects, gradeGroups[`group${i}`] || []);
            }
        }

        function renderGroupSubjects(groupNum, gradeSubjects, selectedSubjects) {
            const container = document.getElementById(`group${groupNum}Subjects`);
            
            let html = '';
            gradeSubjects.forEach(subject => {
                // Skip mandatory subjects
                if (subject.subject === 'English Home Language' || 
                    subject.subject === 'Life Orientation' ||
                    subject.subject.includes('Mathematics') ||
                    subject.subject.includes('Afrikaans') ||
                    subject.subject.includes('isiZulu')) {
                    return;
                }
                
                const isSelected = selectedSubjects.includes(subject.subject);
                
                html += `
                    <div class="subject-checkbox ${isSelected ? 'selected' : ''}" onclick="toggleGroupSubject(${groupNum}, '${subject.subject}', this)">
                        <input type="checkbox" ${isSelected ? 'checked' : ''}>
                        <div class="subject-info">
                            <div class="subject-name">${subject.subject}</div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        function toggleGroupSubject(groupNum, subjectName, element) {
            const checkbox = element.querySelector('input[type="checkbox"]');
            checkbox.checked = !checkbox.checked;
            
            if (checkbox.checked) {
                element.classList.add('selected');
            } else {
                element.classList.remove('selected');
            }
        }

        async function saveGroupConfiguration() {
            const grade = document.getElementById('groupConfigGrade').value;
            if (!grade) return;

            const group1 = [];
            const group2 = [];
            const group3 = [];
            
            // Collect selected subjects from each group
            document.querySelectorAll('#group1Subjects .subject-checkbox.selected').forEach(el => {
                const name = el.querySelector('.subject-name').textContent;
                group1.push(name);
            });
            
            document.querySelectorAll('#group2Subjects .subject-checkbox.selected').forEach(el => {
                const name = el.querySelector('.subject-name').textContent;
                group2.push(name);
            });
            
            document.querySelectorAll('#group3Subjects .subject-checkbox.selected').forEach(el => {
                const name = el.querySelector('.subject-name').textContent;
                group3.push(name);
            });
            
            // Validation
            if (group1.length === 0 || group2.length === 0 || group3.length === 0) {
                showAlert('error', 'Each group must have at least one subject');
                return;
            }
            
            // Save to global object
            subjectGroups[grade] = {
                group1: group1,
                group2: group2,
                group3: group3
            };
            
            await saveToFirebase();
            showAlert('success', `‚úÖ Group configuration saved for Grade ${grade}!`);
        }

        // Capacity Management (same as before)
        function updateStats() {
            let totalSubjects = studentData.length;
            let capacitySet = 0;
            let available = 0;
            let full = 0;
            let overCapacity = 0;
            
            studentData.forEach(item => {
                const capacity = capacities[item.key] || 0;
                if (capacity > 0) {
                    capacitySet++;
                    if (item.count >= capacity) {
                        if (item.count > capacity) {
                            overCapacity++;
                        } else {
                            full++;
                        }
                    } else {
                        available++;
                    }
                }
            });
            
            const statsHtml = `
                <div class="stat-card">
                    <div class="stat-icon">üìö</div>
                    <div class="stat-value">${totalSubjects}</div>
                    <div class="stat-label">Total Subjects</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">‚úÖ</div>
                    <div class="stat-value">${capacitySet}</div>
                    <div class="stat-label">Capacity Set</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üü¢</div>
                    <div class="stat-value">${available}</div>
                    <div class="stat-label">Available</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üü°</div>
                    <div class="stat-value">${full}</div>
                    <div class="stat-label">Full</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üî¥</div>
                    <div class="stat-value">${overCapacity}</div>
                    <div class="stat-label">Over Capacity</div>
                </div>
            `;
            
            document.getElementById('statsContainer').innerHTML = statsHtml;
        }

        function filterSubjects() {
            const searchTerm = document.getElementById('searchSubjects').value.toLowerCase();
            const gradeFilter = document.getElementById('gradeFilter').value;
            const statusFilter = document.getElementById('statusFilter').value;
            
            const rows = document.querySelectorAll('.subjects-table tbody tr');
            
            rows.forEach(row => {
                const subjectText = row.cells[0].textContent.toLowerCase();
                const gradeMatch = !gradeFilter || row.closest('.grade-section').querySelector('.grade-header').textContent.includes(`Grade ${gradeFilter}`);
                
                let statusMatch = true;
                if (statusFilter) {
                    const statusBadge = row.querySelector('.status-badge');
                    if (statusBadge) {
                        const hasStatus = statusBadge.classList.contains(`status-${statusFilter}`);
                        statusMatch = hasStatus;
                    }
                }
                
                const searchMatch = subjectText.includes(searchTerm);
                
                row.style.display = (gradeMatch && statusMatch && searchMatch) ? '' : 'none';
            });
        }

        function setDefaultCapacities() {
            if (confirm('Set default capacities (+20% buffer) for all subjects?')) {
                showLoading('Setting default capacities...');
                studentData.forEach(item => {
                    capacities[item.key] = Math.ceil(item.count * 1.2);
                });
                saveToFirebase();
                renderCapacityManagement();
                updateStats();
                hideLoading();
                showAlert('success', '‚úÖ Default capacities set (+20% buffer)');
            }
        }

        function clearAllCapacities() {
            if (confirm('‚ö†Ô∏è Clear all capacity settings? This action cannot be undone.')) {
                showLoading('Clearing capacities...');
                capacities = {};
                saveToFirebase();
                renderCapacityManagement();
                updateStats();
                hideLoading();
                showAlert('success', '‚úÖ All capacities cleared');
            }
        }

        function setGradeCapacity(grade, multiplier) {
            showLoading(`Setting Grade ${grade} capacities...`);
            studentData.forEach(item => {
                if (item.grade === parseInt(grade)) {
                    capacities[item.key] = Math.ceil(item.count * multiplier);
                }
            });
            saveToFirebase();
            renderCapacityManagement();
            updateStats();
            hideLoading();
            showAlert('success', `‚úÖ Grade ${grade} capacities set to +${((multiplier - 1) * 100).toFixed(0)}%`);
        }

        function updateCapacity(key, value) {
            capacities[key] = parseInt(value) || 0;
        }

        function renderCapacityManagement() {
            const grades = [...new Set(studentData.map(d => d.grade))].sort();
            const div = document.getElementById('capacityManagement');
            div.innerHTML = '';

            grades.forEach(grade => {
                const gradeData = studentData.filter(d => d.grade === grade).sort((a, b) => b.count - a.count);

                let html = `
                    <div class="grade-section">
                        <div class="grade-header">
                            <span>Grade ${grade}</span>
                            <div class="grade-actions">
                                <button onclick="setGradeCapacity(${grade}, 1.1)" class="btn btn-secondary">+10%</button>
                                <button onclick="setGradeCapacity(${grade}, 1.2)" class="btn btn-secondary">+20%</button>
                                <button onclick="setGradeCapacity(${grade}, 1.3)" class="btn btn-secondary">+30%</button>
                            </div>
                        </div>
                        <table class="subjects-table">
                            <thead>
                                <tr>
                                    <th>Subject</th>
                                    <th>Current</th>
                                    <th>Max Capacity</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                `;

                gradeData.forEach(item => {
                    const capacity = capacities[item.key] || 0;
                    const percentage = capacity > 0 ? Math.round((item.count / capacity) * 100) : 0;
                    let statusClass = 'status-available';
                    let statusText = 'Available';
                    
                    if (capacity > 0) {
                        if (item.count > capacity) {
                            statusClass = 'status-over';
                            statusText = 'OVER';
                        } else if (item.count >= capacity) {
                            statusClass = 'status-full';
                            statusText = 'FULL';
                        } else if (percentage >= 90) {
                            statusClass = 'status-full';
                            statusText = 'Near Full';
                        } else if (percentage >= 70) {
                            statusClass = 'status-full';
                            statusText = 'High';
                        }
                    }

                    html += `
                        <tr>
                            <td>${item.subject}</td>
                            <td><span class="current-count">${item.count}</span></td>
                            <td>
                                <input type="number" class="capacity-input" value="${capacity}" 
                                       min="0" placeholder="Set" 
                                       onchange="updateCapacity('${item.key}', this.value); saveToFirebase();" />
                            </td>
                            <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                        </tr>
                    `;
                });

                html += `</tbody></table></div>`;
                div.innerHTML += html;
            });
            
            updateStats();
        }

        function showLoading(message) {
            document.getElementById('loadingMessage').textContent = message;
            document.getElementById('loadingOverlay').classList.add('show');
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').classList.remove('show');
        }

        function showAlert(type, message) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert ${type}`;
            alertDiv.textContent = message;
            alertDiv.style.position = 'fixed';
            alertDiv.style.top = '20px';
            alertDiv.style.right = '20px';
            alertDiv.style.zIndex = '10000';
            alertDiv.style.minWidth = '300px';
            
            document.body.appendChild(alertDiv);
            
            setTimeout(() => {
                alertDiv.remove();
            }, 5000);
        }

        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey && e.key === 's') {
                e.preventDefault();
                saveToFirebase();
            }
            
            if (e.key === 'Escape') {
                if (document.getElementById('confirmationDialog').style.display !== 'none') {
                    cancelAdmission();
                }
            }
        });
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel | Curro Capacity System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
        }

        .container {
            max-width: 1800px;
            margin: 0 auto;
            background: white;
            min-height: 100vh;
        }

        header {
            background: #003c72;
            color: white;
            padding: 25px 40px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        header h1 {
            font-size: 2em;
            font-weight: 600;
        }

        .school-name {
            font-size: 1.2em;
            font-weight: 700;
            color: #f6b242;
            margin-top: 5px;
        }

        .logo {
            font-size: 2.5em;
            font-weight: 700;
            color: #f6b242;
        }

        .nav-bar {
            background: white;
            padding: 15px 40px;
            border-bottom: 3px solid #f6b242;
            display: flex;
            gap: 12px;
            align-items: center;
            flex-wrap: wrap;
        }

        .btn {
            padding: 10px 24px;
            border-radius: 6px;
            font-weight: 600;
            font-size: 0.95em;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
        }

        .btn-primary {
            background: #f6b242;
            color: white;
        }

        .btn-primary:hover {
            background: #d99a2e;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: #003c72;
            color: white;
        }

        .btn-secondary:hover {
            background: #002a54;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .main-content {
            display: grid;
            grid-template-columns: 450px 1fr;
            gap: 0;
            min-height: calc(100vh - 140px);
        }

        .sidebar {
            background: #f8f9fa;
            padding: 30px;
            border-right: 2px solid #e0e0e0;
            overflow-y: auto;
        }

        .content-area {
            padding: 30px 40px;
            overflow-y: auto;
        }

        .section {
            background: white;
            border-radius: 8px;
            padding: 25px;
            margin-bottom: 25px;
            border: 1px solid #e0e0e0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .section h2 {
            color: #003c72;
            font-size: 1.4em;
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 2px solid #f6b242;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            color: #495057;
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 0.95em;
        }

        .form-group select,
        .form-group input[type="number"] {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 1em;
            transition: border-color 0.2s;
        }

        .form-group select:focus,
        .form-group input:focus {
            outline: none;
            border-color: #f6b242;
        }

        .subjects-checklist {
            max-height: 300px;
            overflow-y: auto;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            padding: 15px;
            background: white;
        }

        .subject-checkbox {
            display: flex;
            align-items: center;
            padding: 8px;
            margin-bottom: 8px;
            border-radius: 4px;
            transition: background 0.2s;
        }

        .subject-checkbox:hover {
            background: #f8f9fa;
        }

        .subject-checkbox input[type="checkbox"] {
            margin-right: 10px;
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .subject-checkbox label {
            cursor: pointer;
            flex: 1;
            font-weight: normal !important;
            margin: 0 !important;
        }

        .result-box {
            padding: 15px;
            border-radius: 6px;
            margin-top: 15px;
            display: none;
        }

        .result-box.success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
            display: block;
        }

        .result-box.error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
            display: block;
        }

        .result-box.info {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
            display: block;
        }

        .capacity-info {
            font-size: 0.9em;
            color: #6c757d;
            margin-top: 5px;
        }

        .file-input-wrapper {
            position: relative;
            display: inline-block;
            width: 100%;
        }

        .file-input-wrapper input[type="file"] {
            display: none;
        }

        .file-input-label {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            padding: 12px 20px;
            background: #f6b242;
            color: white;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 600;
        }

        .file-input-label:hover {
            background: #d99a2e;
        }

        .grade-section {
            margin-bottom: 30px;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid #e0e0e0;
        }

        .grade-header {
            background: #003c72;
            color: white;
            padding: 15px 25px;
            font-size: 1.3em;
            font-weight: 600;
        }

        .subjects-table {
            width: 100%;
            border-collapse: collapse;
        }

        .subjects-table thead {
            background: #f8f9fa;
        }

        .subjects-table th {
            padding: 12px 20px;
            text-align: left;
            font-weight: 600;
            color: #003c72;
            font-size: 0.9em;
            border-bottom: 2px solid #f6b242;
        }

        .subjects-table td {
            padding: 12px 20px;
            border-bottom: 1px solid #e9ecef;
        }

        .subjects-table tr:hover {
            background: #f8f9fa;
        }

        .capacity-input {
            width: 100px;
            padding: 6px 10px;
            border: 2px solid #e0e0e0;
            border-radius: 4px;
            text-align: center;
        }

        .current-count {
            font-size: 1.2em;
            font-weight: 700;
            color: #f6b242;
        }

        .status-badge {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.85em;
            font-weight: 600;
        }

        .status-available { background: #d4edda; color: #155724; }
        .status-full { background: #fff3cd; color: #856404; }
        .status-over { background: #f8d7da; color: #721c24; }

        @media (max-width: 1200px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            .sidebar {
                border-right: none;
                border-bottom: 2px solid #e0e0e0;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div>
                <h1>Admin Panel</h1>
                <div class="school-name" id="schoolName">CURRO RIVONIA</div>
            </div>
            <div class="logo">CURRO</div>
        </header>

        <div class="nav-bar">
            <a href="dashboard.html" class="btn btn-primary">üìä View Dashboard</a>
            <button onclick="saveToFirebase()" class="btn btn-secondary">‚òÅÔ∏è Save to Cloud</button>
            <button onclick="loadFromFirebase()" class="btn btn-secondary">üîÑ Reload from Cloud</button>
            <div style="flex: 1;"></div>
            <span style="color: #6c757d; font-size: 0.9em; margin-right: 15px;">üë§ <span id="userEmail">Loading...</span></span>
            <button onclick="signOut()" class="btn btn-danger">üö™ Sign Out</button>
        </div>

        <div class="main-content">
            <div class="sidebar">
                <div class="section">
                    <h2>‚úÖ Check Student Admission</h2>
                    
                    <div class="form-group">
                        <label>Student Name</label>
                        <input type="text" id="studentName" placeholder="Enter student full name" style="width: 100%; padding: 10px 12px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 1em;">
                    </div>

                    <div class="form-group">
                        <label>Select Grade</label>
                        <select id="admissionGrade" onchange="loadSubjectsForGrade()">
                            <option value="">-- Choose Grade --</option>
                            <option value="8">Grade 8</option>
                            <option value="9">Grade 9</option>
                            <option value="10">Grade 10</option>
                            <option value="11">Grade 11</option>
                            <option value="12">Grade 12</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Select Subjects Student Wants</label>
                        <div class="subjects-checklist" id="subjectsList">
                            <p style="color: #6c757d; text-align: center;">Select a grade first</p>
                        </div>
                    </div>

                    <button onclick="checkCapacity()" class="btn btn-secondary" style="width: 100%; margin-bottom: 10px;">
                        üîç Check if Student Can Be Admitted
                    </button>

                    <div id="admissionResult" class="result-box"></div>

                    <button onclick="admitStudent()" id="admitBtn" class="btn btn-success" style="width: 100%; display: none;">
                        ‚ûï Admit Student (Update Counts)
                    </button>
                </div>

                <div class="section">
                    <h2>üì§ Upload CSV Data</h2>
                    <div class="file-input-wrapper">
                        <input type="file" id="fileInput" accept=".csv" />
                        <label for="fileInput" class="file-input-label">
                            <span>üìÑ</span>
                            <span>Upload CSV Report</span>
                        </label>
                    </div>
                    <div id="uploadStatus" style="margin-top: 10px; color: #6c757d; font-size: 0.9em;"></div>
                </div>

                <div class="section">
                    <h2>‚öôÔ∏è Quick Actions</h2>
                    <button onclick="setDefaultCapacities()" class="btn btn-secondary" style="width: 100%; margin-bottom: 10px;">
                        Set Default Capacities (+20%)
                    </button>
                    <button onclick="clearAllCapacities()" class="btn btn-danger" style="width: 100%;">
                        Clear All Capacities
                    </button>
                </div>

                <div class="section">
                    <h2>üìß Email Notifications</h2>
                    <div class="form-group">
                        <label>Recipient Email Addresses</label>
                        <textarea id="emailRecipients" placeholder="Enter email addresses (one per line)&#10;example@currorivonia.co.za&#10;admin@currorivonia.co.za" style="width: 100%; padding: 10px 12px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 0.9em; min-height: 100px; font-family: inherit; resize: vertical;"></textarea>
                        <small style="color: #6c757d; font-size: 0.85em;">Emails will be sent when a student is admitted</small>
                    </div>
                    <button onclick="saveEmailSettings()" class="btn btn-secondary" style="width: 100%;">
                        üíæ Save Email Settings
                    </button>
                </div>
            </div>

            <div class="content-area">
                <h2 style="color: #003c72; margin-bottom: 20px; font-size: 1.6em;">Capacity Management</h2>
                <div id="capacityManagement"></div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <!-- EmailJS SDK -->
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>

    <script>
        // YOUR FIREBASE CONFIGURATION - ALREADY SET UP!
        const firebaseConfig = {
            apiKey: "AIzaSyA5US45QlRkkIgNzvGY8NxOtgxhtBFrVV0",
            authDomain: "db-test-4e542.firebaseapp.com",
            databaseURL: "https://db-test-4e542-default-rtdb.firebaseio.com",
            projectId: "db-test-4e542",
            storageBucket: "db-test-4e542.firebasestorage.app",
            messagingSenderId: "635686299111",
            appId: "1:635686299111:web:44c438ded2deeb87fe0942"
        };

        // Initialize Firebase
        let database;
        let auth;
        try {
            firebase.initializeApp(firebaseConfig);
            database = firebase.database();
            auth = firebase.auth();
            console.log("‚úÖ Firebase initialized successfully");
        } catch (error) {
            console.error("‚ùå Firebase initialization error:", error);
            alert("Firebase error: " + error.message);
        }

        // Check authentication status
        auth.onAuthStateChanged((user) => {
            if (!user) {
                // Not logged in, redirect to login page
                window.location.href = 'login.html?redirect=admin.html';
            } else {
                // User is logged in
                console.log("‚úÖ User authenticated:", user.email);
                if (document.getElementById('userEmail')) {
                    document.getElementById('userEmail').textContent = user.email;
                }
            }
        });

        // Sign out function
        function signOut() {
            if (confirm('Are you sure you want to sign out?')) {
                auth.signOut().then(() => {
                    window.location.href = 'login.html';
                }).catch((error) => {
                    alert('Error signing out: ' + error.message);
                });
            }
        }

        let studentData = [];
        let capacities = {};
        let selectedSubjects = [];
        let emailRecipients = [];

        // Initialize EmailJS - CONFIGURED WITH YOUR CREDENTIALS
        const EMAILJS_PUBLIC_KEY = 'Vw5a0CwDdKhv90Z-N';
        const EMAILJS_SERVICE_ID = 'service_wu805b1';
        const EMAILJS_TEMPLATE_ID = 'template_4dhxbfk';

        // Initialize EmailJS
        if (typeof emailjs !== 'undefined') {
            emailjs.init(EMAILJS_PUBLIC_KEY);
            console.log('‚úÖ EmailJS initialized successfully');
        }

        // Initial CSV data
        const initialCSVData = `Brand_Name,Company_Name,Textbox4,Textbox2,Textbox26,Textbox40
Curro,Curro Rivonia,10,Accounting,12,2755
Curro,Curro Rivonia,10,Advanced Programme English,2,2755
Curro,Curro Rivonia,10,Advanced Programme Mathematics,9,2755
Curro,Curro Rivonia,10,Afrikaans First Additional Language,47,2755
Curro,Curro Rivonia,10,Business Studies,45,2755
Curro,Curro Rivonia,10,Computer Applications Technology,29,2755
Curro,Curro Rivonia,10,Engineering Graphics and Design,16,2755
Curro,Curro Rivonia,10,English Home Language,70,2755
Curro,Curro Rivonia,10,History,25,2755
Curro,Curro Rivonia,10,Information Technology,19,2755
Curro,Curro Rivonia,10,isiZulu First Additional Language,18,2755
Curro,Curro Rivonia,10,Life Orientation,70,2755
Curro,Curro Rivonia,10,Life Sciences,24,2755
Curro,Curro Rivonia,10,Mathematical Literacy,34,2755
Curro,Curro Rivonia,10,Mathematics,50,2755
Curro,Curro Rivonia,10,Physical Sciences,33,2755
Curro,Curro Rivonia,10,Tourism,23,2755
Curro,Curro Rivonia,10,Visual Arts,12,2755
Curro,Curro Rivonia,11,Accounting,13,2755
Curro,Curro Rivonia,11,Advanced Programme English,4,2755
Curro,Curro Rivonia,11,Advanced Programme Mathematics,7,2755
Curro,Curro Rivonia,11,Afrikaans First Additional Language,51,2755
Curro,Curro Rivonia,11,Business Studies,36,2755
Curro,Curro Rivonia,11,Computer Applications Technology,14,2755
Curro,Curro Rivonia,11,Economics,3,2755
Curro,Curro Rivonia,11,Engineering Graphics and Design,15,2755
Curro,Curro Rivonia,11,English Home Language,69,2755
Curro,Curro Rivonia,11,Geography,3,2755
Curro,Curro Rivonia,11,History,34,2755
Curro,Curro Rivonia,11,Information Technology,10,2755
Curro,Curro Rivonia,11,isiZulu First Additional Language,17,2755
Curro,Curro Rivonia,11,Life Orientation,69,2755
Curro,Curro Rivonia,11,Life Sciences,30,2755
Curro,Curro Rivonia,11,Mathematical Literacy,30,2755
Curro,Curro Rivonia,11,Mathematics,44,2755
Curro,Curro Rivonia,11,Physical Sciences,27,2755
Curro,Curro Rivonia,11,Tourism,33,2755
Curro,Curro Rivonia,11,Visual Arts,5,2755
Curro,Curro Rivonia,12,Accounting,9,2755
Curro,Curro Rivonia,12,Advanced Programme Mathematics,2,2755
Curro,Curro Rivonia,12,Afrikaans First Additional Language,44,2755
Curro,Curro Rivonia,12,Business Studies,31,2755
Curro,Curro Rivonia,12,Computer Applications Technology,16,2755
Curro,Curro Rivonia,12,Economics,7,2755
Curro,Curro Rivonia,12,Engineering Graphics and Design,13,2755
Curro,Curro Rivonia,12,English Home Language,65,2755
Curro,Curro Rivonia,12,French Second Additional Language,2,2755
Curro,Curro Rivonia,12,Geography,8,2755
Curro,Curro Rivonia,12,History,30,2755
Curro,Curro Rivonia,12,Information Technology,5,2755
Curro,Curro Rivonia,12,isiZulu First Additional Language,15,2755
Curro,Curro Rivonia,12,Life Orientation,64,2755
Curro,Curro Rivonia,12,Life Sciences,27,2755
Curro,Curro Rivonia,12,Mathematical Literacy,37,2755
Curro,Curro Rivonia,12,Mathematics,35,2755
Curro,Curro Rivonia,12,Physical Sciences,18,2755
Curro,Curro Rivonia,12,Portuguese Second Additional Language,1,2755
Curro,Curro Rivonia,12,Tourism,19,2755
Curro,Curro Rivonia,12,Visual Arts,13,2755
Curro,Curro Rivonia,8,Afrikaans First Additional Language,59,2755
Curro,Curro Rivonia,8,Business Studies,74,2755
Curro,Curro Rivonia,8,Coding and Robotics ,74,2755
Curro,Curro Rivonia,8,Creative Arts,74,2755
Curro,Curro Rivonia,8,English Home Language,74,2755
Curro,Curro Rivonia,8,isiZulu First Additional Language,15,2755
Curro,Curro Rivonia,8,Life Orientation,74,2755
Curro,Curro Rivonia,8,Mathematics,74,2755
Curro,Curro Rivonia,8,Natural Sciences,74,2755
Curro,Curro Rivonia,8,Social Sciences,74,2755
Curro,Curro Rivonia,9,Accounting,64,2755
Curro,Curro Rivonia,9,Afrikaans First Additional Language,45,2755
Curro,Curro Rivonia,9,Coding and Robotics ,64,2755
Curro,Curro Rivonia,9,Creative Arts,64,2755
Curro,Curro Rivonia,9,English Home Language,64,2755
Curro,Curro Rivonia,9,isiZulu First Additional Language,19,2755
Curro,Curro Rivonia,9,Life Orientation,64,2755
Curro,Curro Rivonia,9,Mathematics,64,2755
Curro,Curro Rivonia,9,Natural Sciences,64,2755
Curro,Curro Rivonia,9,Social Sciences,64,2755`;

        window.addEventListener('DOMContentLoaded', () => {
            parseCSV(initialCSVData);
            loadFromFirebase();
        });

        document.getElementById('fileInput').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    parseCSV(event.target.result);
                    document.getElementById('uploadStatus').textContent = `‚úì Loaded: ${file.name}`;
                    saveToFirebase();
                    renderCapacityManagement();
                };
                reader.readAsText(file);
            }
        });

        function parseCSV(text) {
            const lines = text.trim().split('\n');
            studentData = [];
            
            for (let i = 1; i < lines.length; i++) {
                if (lines[i].trim()) {
                    const parts = lines[i].split(',');
                    if (parts.length >= 6) {
                        studentData.push({
                            brand: parts[0].trim(),
                            school: parts[1].trim(),
                            grade: parseInt(parts[2]),
                            subject: parts[3].trim(),
                            count: parseInt(parts[4]),
                            key: `${parts[2]}-${parts[3].trim()}`
                        });
                    }
                }
            }

            if (studentData.length > 0) {
                document.getElementById('schoolName').textContent = studentData[0].school.toUpperCase();
            }
        }

        async function saveToFirebase() {
            if (!database) {
                alert("Firebase not initialized properly");
                return;
            }

            try {
                await database.ref('studentData').set(studentData);
                await database.ref('capacities').set(capacities);
                await database.ref('emailRecipients').set(emailRecipients);
                alert("‚úÖ Data saved to cloud successfully!");
            } catch (error) {
                console.error("Error saving to Firebase:", error);
                alert("‚ùå Error saving to cloud: " + error.message);
            }
        }

        async function loadFromFirebase() {
            if (!database) return;

            try {
                const dataSnapshot = await database.ref('studentData').once('value');
                const capSnapshot = await database.ref('capacities').once('value');
                const emailSnapshot = await database.ref('emailRecipients').once('value');
                
                if (dataSnapshot.exists()) {
                    studentData = dataSnapshot.val();
                }
                
                if (capSnapshot.exists()) {
                    capacities = capSnapshot.val();
                }

                if (emailSnapshot.exists()) {
                    emailRecipients = emailSnapshot.val();
                    document.getElementById('emailRecipients').value = emailRecipients.join('\n');
                }

                renderCapacityManagement();
            } catch (error) {
                console.error("Error loading from Firebase:", error);
            }
        }

        function loadSubjectsForGrade() {
            const grade = document.getElementById('admissionGrade').value;
            const listDiv = document.getElementById('subjectsList');
            
            if (!grade) {
                listDiv.innerHTML = '<p style="color: #6c757d; text-align: center;">Select a grade first</p>';
                return;
            }

            const gradeSubjects = studentData.filter(s => s.grade === parseInt(grade));
            
            let html = '';
            gradeSubjects.forEach(subject => {
                const capacity = capacities[subject.key] || 0;
                const available = capacity - subject.count;
                const capInfo = capacity > 0 ? `(${subject.count}/${capacity})` : '(no limit set)';
                
                html += `
                    <div class="subject-checkbox">
                        <input type="checkbox" id="sub_${subject.key}" value="${subject.key}">
                        <label for="sub_${subject.key}">
                            ${subject.subject}
                            <span class="capacity-info">${capInfo}</span>
                        </label>
                    </div>
                `;
            });

            listDiv.innerHTML = html;
        }

        function checkCapacity() {
            const grade = document.getElementById('admissionGrade').value;
            if (!grade) {
                alert("Please select a grade first");
                return;
            }

            selectedSubjects = [];
            const checkboxes = document.querySelectorAll('.subject-checkbox input[type="checkbox"]:checked');
            
            if (checkboxes.length === 0) {
                alert("Please select at least one subject");
                return;
            }

            checkboxes.forEach(cb => {
                selectedSubjects.push(cb.value);
            });

            let canAdmit = true;
            let fullSubjects = [];
            let results = [];

            selectedSubjects.forEach(key => {
                const subject = studentData.find(s => s.key === key);
                const capacity = capacities[key] || 0;
                
                if (capacity === 0) {
                    results.push(`‚ö†Ô∏è ${subject.subject}: No capacity set`);
                } else if (subject.count >= capacity) {
                    canAdmit = false;
                    fullSubjects.push(subject.subject);
                    results.push(`‚ùå ${subject.subject}: FULL (${subject.count}/${capacity})`);
                } else {
                    const available = capacity - subject.count;
                    results.push(`‚úÖ ${subject.subject}: ${available} space${available > 1 ? 's' : ''} available`);
                }
            });

            const resultDiv = document.getElementById('admissionResult');
            const admitBtn = document.getElementById('admitBtn');

            if (canAdmit && fullSubjects.length === 0) {
                resultDiv.className = 'result-box success';
                resultDiv.innerHTML = `
                    <strong>‚úÖ Student CAN be admitted!</strong><br><br>
                    ${results.join('<br>')}
                `;
                admitBtn.style.display = 'block';
            } else {
                resultDiv.className = 'result-box error';
                resultDiv.innerHTML = `
                    <strong>‚ùå Cannot admit student</strong><br><br>
                    ${results.join('<br>')}
                    ${fullSubjects.length > 0 ? `<br><br><strong>Full subjects:</strong> ${fullSubjects.join(', ')}` : ''}
                `;
                admitBtn.style.display = 'none';
            }
        }

        function saveEmailSettings() {
            const emailText = document.getElementById('emailRecipients').value;
            emailRecipients = emailText.split('\n')
                .map(email => email.trim())
                .filter(email => email.length > 0 && email.includes('@'));
            
            saveToFirebase();
            alert(`‚úÖ Email settings saved! ${emailRecipients.length} recipient(s) configured.`);
        }

        async function sendAdmissionEmail(studentName, grade, subjects) {
            // Check if EmailJS is configured
            if (EMAILJS_PUBLIC_KEY === 'YOUR_EMAILJS_PUBLIC_KEY') {
                console.log('EmailJS not configured - skipping email');
                return;
            }

            // Check if there are recipients
            if (emailRecipients.length === 0) {
                console.log('No email recipients configured - skipping email');
                return;
            }

            try {
                // Get subject names
                const subjectNames = subjects.map(key => {
                    const subject = studentData.find(s => s.key === key);
                    return subject ? subject.subject : key;
                });

                // Send email to each recipient
                for (const recipient of emailRecipients) {
                    const templateParams = {
                        to_email: recipient,
                        student_name: studentName,
                        grade: grade,
                        subjects: subjectNames.join(', '),
                        subject_list: subjectNames.map(s => `‚Ä¢ ${s}`).join('\n'),
                        date: new Date().toLocaleDateString('en-ZA', { 
                            year: 'numeric', 
                            month: 'long', 
                            day: 'numeric',
                            hour: '2-digit',
                            minute: '2-digit'
                        })
                    };

                    await emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_ID, templateParams);
                    console.log(`‚úÖ Email sent to ${recipient}`);
                }

                return true;
            } catch (error) {
                console.error('Error sending email:', error);
                return false;
            }
        }

        async function admitStudent() {
            if (selectedSubjects.length === 0) return;

            const studentName = document.getElementById('studentName').value.trim();
            const grade = document.getElementById('admissionGrade').value;

            if (!studentName) {
                alert("Please enter the student's name before admitting.");
                return;
            }

            if (!confirm(`Admit ${studentName} to Grade ${grade} for ${selectedSubjects.length} subject(s)?\n\nThis will increase the student count by 1 for each selected subject.`)) {
                return;
            }

            selectedSubjects.forEach(key => {
                const subject = studentData.find(s => s.key === key);
                if (subject) {
                    subject.count++;
                }
            });

            await saveToFirebase();
            renderCapacityManagement();
            
            // Send email notification
            const emailSent = await sendAdmissionEmail(studentName, grade, selectedSubjects);
            
            const resultDiv = document.getElementById('admissionResult');
            resultDiv.className = 'result-box success';
            
            let emailStatus = '';
            if (emailRecipients.length > 0) {
                if (emailSent) {
                    emailStatus = `<br><br>üìß Email notifications sent to ${emailRecipients.length} recipient(s)`;
                } else {
                    emailStatus = '<br><br>‚ö†Ô∏è Email notification failed (check console for details)';
                }
            }
            
            resultDiv.innerHTML = `<strong>‚úÖ ${studentName} admitted successfully to Grade ${grade}!</strong><br>Counts updated and saved to cloud.${emailStatus}`;
            
            document.getElementById('admitBtn').style.display = 'none';
            
            // Clear form
            document.getElementById('studentName').value = '';
            document.querySelectorAll('.subject-checkbox input[type="checkbox"]').forEach(cb => cb.checked = false);
            selectedSubjects = [];
        }

        function setDefaultCapacities() {
            studentData.forEach(item => {
                capacities[item.key] = Math.ceil(item.count * 1.2);
            });
            saveToFirebase();
            renderCapacityManagement();
            alert("‚úÖ Default capacities set (+20% buffer)");
        }

        function clearAllCapacities() {
            if (confirm('Clear all capacity settings?')) {
                capacities = {};
                saveToFirebase();
                renderCapacityManagement();
            }
        }

        function updateCapacity(key, value) {
            capacities[key] = parseInt(value) || 0;
        }

        function renderCapacityManagement() {
            const grades = [...new Set(studentData.map(d => d.grade))].sort();
            const div = document.getElementById('capacityManagement');
            div.innerHTML = '';

            grades.forEach(grade => {
                const gradeData = studentData.filter(d => d.grade === grade).sort((a, b) => b.count - a.count);

                let html = `
                    <div class="grade-section">
                        <div class="grade-header">Grade ${grade}</div>
                        <table class="subjects-table">
                            <thead>
                                <tr>
                                    <th>Subject</th>
                                    <th>Current</th>
                                    <th>Max Capacity</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                `;

                gradeData.forEach(item => {
                    const capacity = capacities[item.key] || 0;
                    const percentage = capacity > 0 ? Math.round((item.count / capacity) * 100) : 0;
                    let statusClass = 'status-available';
                    let statusText = 'Available';
                    
                    if (capacity > 0) {
                        if (item.count >= capacity) {
                            statusClass = 'status-over';
                            statusText = 'FULL';
                        } else if (percentage >= 90) {
                            statusClass = 'status-full';
                            statusText = 'Near Full';
                        }
                    }

                    html += `
                        <tr>
                            <td>${item.subject}</td>
                            <td><span class="current-count">${item.count}</span></td>
                            <td>
                                <input type="number" class="capacity-input" value="${capacity}" 
                                       min="0" placeholder="Set" 
                                       onchange="updateCapacity('${item.key}', this.value); saveToFirebase();" />
                            </td>
                            <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                        </tr>
                    `;
                });

                html += `</tbody></table></div>`;
                div.innerHTML += html;
            });
        }
    </script>
</body>
</html>
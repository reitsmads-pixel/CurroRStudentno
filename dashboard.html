<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Capacity Dashboard | Curro</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
        }

        .container {
            max-width: 1800px;
            margin: 0 auto;
            background: white;
            min-height: 100vh;
        }

        header {
            background: #003c72;
            color: white;
            padding: 25px 40px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        header h1 {
            font-size: 2em;
            font-weight: 600;
        }

        .school-name {
            font-size: 1.2em;
            font-weight: 700;
            color: #f6b242;
            margin-top: 5px;
        }

        .last-updated {
            font-size: 0.85em;
            opacity: 0.9;
            margin-top: 8px;
        }

        .logo {
            font-size: 2.5em;
            font-weight: 700;
            color: #f6b242;
        }

        .nav-bar {
            background: white;
            padding: 15px 40px;
            border-bottom: 3px solid #f6b242;
            display: flex;
            gap: 12px;
            align-items: center;
            flex-wrap: wrap;
        }

        .btn {
            padding: 10px 24px;
            border-radius: 6px;
            font-weight: 600;
            font-size: 0.95em;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
        }

        .btn-primary {
            background: #003c72;
            color: white;
        }

        .btn-primary:hover {
            background: #002a54;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .live-indicator {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 6px 14px;
            background: #d4edda;
            color: #155724;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
        }

        .live-dot {
            width: 8px;
            height: 8px;
            background: #28a745;
            border-radius: 50%;
            animation: blink 2s infinite;
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        /* Summary Statistics */
        .summary-section {
            background: linear-gradient(135deg, #003c72 0%, #005a9e 100%);
            padding: 30px 40px;
            color: white;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        .summary-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            padding: 20px;
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            text-align: center;
        }

        .summary-card .icon {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .summary-card .value {
            font-size: 2.5em;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .summary-card .label {
            font-size: 0.9em;
            opacity: 0.9;
        }

        /* Filter Controls */
        .filter-section {
            background: white;
            padding: 20px 40px;
            border-bottom: 2px solid #e0e0e0;
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .search-box {
            flex: 1;
            min-width: 250px;
        }

        .search-box input {
            width: 100%;
            padding: 10px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 1em;
        }

        .search-box input:focus {
            outline: none;
            border-color: #f6b242;
        }

        .filter-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .filter-group select {
            padding: 10px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 0.95em;
            cursor: pointer;
        }

        .filter-group select:focus {
            outline: none;
            border-color: #f6b242;
        }

        .view-toggle {
            display: flex;
            background: #f8f9fa;
            border-radius: 6px;
            padding: 4px;
            gap: 4px;
        }

        .view-toggle button {
            padding: 8px 16px;
            border: none;
            background: transparent;
            cursor: pointer;
            border-radius: 4px;
            font-weight: 600;
            transition: all 0.2s;
        }

        .view-toggle button.active {
            background: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        /* Legend */
        .legend {
            padding: 20px 40px;
            background: #f8f9fa;
            border-bottom: 1px solid #e0e0e0;
        }

        .legend h3 {
            color: #003c72;
            margin-bottom: 12px;
            font-size: 1.1em;
        }

        .legend-grid {
            display: flex;
            gap: 25px;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .legend-color {
            width: 45px;
            height: 22px;
            border-radius: 4px;
            border: 1px solid rgba(0,0,0,0.1);
        }

        .legend-color.low { background: #28a745; }
        .legend-color.medium { background: #17a2b8; }
        .legend-color.high { background: #ffc107; }
        .legend-color.full { background: #f6b242; }
        .legend-color.over { background: #dc3545; }

        /* Dashboard Content */
        .dashboard {
            padding: 30px 40px;
            background: #f8f9fa;
        }

        /* Grid View */
        .grade-section {
            margin-bottom: 30px;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid #e0e0e0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        }

        .grade-header {
            background: #003c72;
            color: white;
            padding: 18px 30px;
            font-size: 1.5em;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .grade-stats {
            font-size: 0.7em;
            opacity: 0.9;
            display: flex;
            gap: 20px;
        }

        .subject-grid {
            padding: 25px;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 20px;
        }

        .subject-card {
            background: #f8f9fa;
            padding: 18px;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
            transition: all 0.2s;
        }

        .subject-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            border-color: #f6b242;
        }

        .subject-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }

        .subject-name {
            font-weight: 700;
            color: #003c72;
            font-size: 1.05em;
            flex: 1;
            line-height: 1.3;
        }

        .subject-numbers {
            text-align: right;
            margin-left: 12px;
        }

        .current-number {
            font-size: 1.8em;
            font-weight: 700;
            color: #f6b242;
            line-height: 1;
        }

        .max-number {
            font-size: 0.9em;
            color: #6c757d;
            margin-top: 2px;
            font-weight: 500;
        }

        .capacity-bar-container {
            width: 100%;
            height: 28px;
            background: #e9ecef;
            border-radius: 6px;
            overflow: hidden;
            border: 1px solid #dee2e6;
            position: relative;
        }

        .capacity-bar {
            height: 100%;
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            font-size: 0.9em;
        }

        .capacity-bar.low { background: #28a745; }
        .capacity-bar.medium { background: #17a2b8; }
        .capacity-bar.high { background: #ffc107; color: #000; }
        .capacity-bar.full { background: #f6b242; }
        .capacity-bar.over { background: #dc3545; animation: pulse 2s infinite; }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.85; }
        }

        .status-label {
            margin-top: 8px;
            font-size: 0.85em;
            font-weight: 600;
            text-align: center;
        }

        .status-label.low { color: #28a745; }
        .status-label.medium { color: #17a2b8; }
        .status-label.high { color: #ff9800; }
        .status-label.full { color: #f6b242; }
        .status-label.over { color: #dc3545; }

        /* Table View */
        .table-view {
            display: none;
        }

        .table-view.active {
            display: block;
        }

        .subjects-table {
            width: 100%;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid #e0e0e0;
        }

        .subjects-table table {
            width: 100%;
            border-collapse: collapse;
        }

        .subjects-table thead {
            background: #003c72;
            color: white;
        }

        .subjects-table th {
            padding: 15px 20px;
            text-align: left;
            font-weight: 600;
            font-size: 0.95em;
        }

        .subjects-table td {
            padding: 12px 20px;
            border-bottom: 1px solid #e9ecef;
        }

        .subjects-table tbody tr:hover {
            background: #f8f9fa;
        }

        .subjects-table tbody tr:last-child td {
            border-bottom: none;
        }

        .table-capacity {
            font-size: 1.1em;
            font-weight: 700;
            color: #f6b242;
        }

        .table-status {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.85em;
            font-weight: 600;
        }

        .table-status.available { background: #d4edda; color: #155724; }
        .table-status.high { background: #fff3cd; color: #856404; }
        .table-status.full { background: #f8d7da; color: #721c24; }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #6c757d;
        }

        .empty-state .icon {
            font-size: 4em;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .empty-state h3 {
            font-size: 1.5em;
            margin-bottom: 10px;
        }

        /* Print Styles */
        @media print {
            .nav-bar, .filter-section, .btn {
                display: none !important;
            }

            .subject-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .subject-card {
                break-inside: avoid;
            }
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            header {
                flex-direction: column;
                text-align: center;
                gap: 12px;
            }

            .nav-bar, .filter-section {
                padding: 15px 20px;
            }

            .summary-section {
                padding: 20px;
            }

            .summary-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 15px;
            }

            .summary-card {
                padding: 15px;
            }

            .summary-card .value {
                font-size: 2em;
            }

            .filter-section {
                flex-direction: column;
                align-items: stretch;
            }

            .search-box {
                width: 100%;
            }

            .filter-group {
                flex-direction: column;
            }

            .filter-group select {
                width: 100%;
            }

            .dashboard {
                padding: 20px;
            }

            .subject-grid {
                grid-template-columns: 1fr;
                padding: 15px;
            }

            .grade-header {
                flex-direction: column;
                gap: 10px;
                align-items: flex-start;
            }

            .subjects-table {
                font-size: 0.85em;
            }

            .subjects-table th,
            .subjects-table td {
                padding: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div>
                <h1>Student Capacity Dashboard</h1>
                <div class="school-name" id="schoolName">CURRO RIVONIA</div>
                <div class="last-updated" id="lastUpdated">Loading...</div>
            </div>
            <div class="logo">CURRO</div>
        </header>

        <div class="nav-bar">
            <a href="main_admin.html" class="btn btn-primary">üîß Admin Panel</a>
            <button onclick="exportToPDF()" class="btn btn-secondary">üìÑ Export PDF</button>
            <button onclick="exportToExcel()" class="btn btn-secondary">üìä Export Excel</button>
            <button onclick="window.print()" class="btn btn-secondary">üñ®Ô∏è Print</button>
            <div class="live-indicator">
                <div class="live-dot"></div>
                <span>Live Sync</span>
            </div>
            <div style="flex: 1;"></div>
            <span style="color: #6c757d; font-size: 0.9em; margin-right: 15px;">üë§ <span id="userEmail">Loading...</span></span>
            <button onclick="signOut()" class="btn btn-secondary">üö™ Sign Out</button>
        </div>

        <!-- Summary Statistics -->
        <div class="summary-section">
            <div class="summary-grid" id="summaryStats">
                <!-- Stats will be populated here -->
            </div>
        </div>

        <!-- Filter Controls -->
        <div class="filter-section">
            <div class="search-box">
                <input type="text" id="searchInput" placeholder="üîç Search subjects..." onkeyup="applyFilters()">
            </div>
            <div class="filter-group">
                <select id="gradeFilter" onchange="applyFilters()">
                    <option value="">All Grades</option>
                    <option value="8">Grade 8</option>
                    <option value="9">Grade 9</option>
                    <option value="10">Grade 10</option>
                    <option value="11">Grade 11</option>
                    <option value="12">Grade 12</option>
                </select>
                <select id="statusFilter" onchange="applyFilters()">
                    <option value="">All Status</option>
                    <option value="available">Available</option>
                    <option value="moderate">Moderate</option>
                    <option value="high">High</option>
                    <option value="full">Full</option>
                    <option value="over">Over Capacity</option>
                </select>
                <select id="sortFilter" onchange="applyFilters()">
                    <option value="percentage-desc">Capacity % (High to Low)</option>
                    <option value="percentage-asc">Capacity % (Low to High)</option>
                    <option value="count-desc">Students (Most to Least)</option>
                    <option value="count-asc">Students (Least to Most)</option>
                    <option value="name-asc">Name (A-Z)</option>
                    <option value="name-desc">Name (Z-A)</option>
                </select>
            </div>
            <div class="view-toggle">
                <button class="active" onclick="switchView('grid')">üìä Cards</button>
                <button onclick="switchView('table')">üìã Table</button>
            </div>
        </div>

        <div class="legend">
            <h3>Capacity Status Legend</h3>
            <div class="legend-grid">
                <div class="legend-item">
                    <div class="legend-color low"></div>
                    <span>0-50% Available</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color medium"></div>
                    <span>51-70% Moderate</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color high"></div>
                    <span>71-90% High</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color full"></div>
                    <span>91-100% Full</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color over"></div>
                    <span>Over 100% Over Capacity</span>
                </div>
            </div>
        </div>

        <!-- Grid View -->
        <div class="dashboard grid-view" id="gridView"></div>

        <!-- Table View -->
        <div class="dashboard table-view" id="tableView"></div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    
    <!-- Load configuration from external file -->
    <script src="config.js"></script>

    <script>
        // Firebase Configuration loaded from config.js
        
        let database;
        let auth;
        try {
            firebase.initializeApp(firebaseConfig);
            database = firebase.database();
            auth = firebase.auth();
            console.log("‚úÖ Firebase initialized");
        } catch (error) {
            console.error("‚ùå Firebase error:", error);
        }

        // Authentication
        auth.onAuthStateChanged((user) => {
            if (!user) {
                window.location.href = 'login.html?redirect=dashboard.html';
            } else {
                console.log("‚úÖ User authenticated:", user.email);
                if (document.getElementById('userEmail')) {
                    document.getElementById('userEmail').textContent = user.email;
                }
                // NOW setup Firebase listeners (after authentication)
                console.log("‚òÅÔ∏è Setting up Firebase data listeners...");
                setupFirebaseListeners();
            }
        });

        function signOut() {
            if (confirm('Are you sure you want to sign out?')) {
                auth.signOut().then(() => {
                    window.location.href = 'login.html';
                }).catch((error) => {
                    alert('Error signing out: ' + error.message);
                });
            }
        }

        // Global variables
        let studentData = [];
        let capacities = {};
        let filteredData = [];
        let currentView = 'grid';

        // Initial CSV data
        const initialCSVData = `Brand_Name,Company_Name,Textbox4,Textbox2,Textbox26,Textbox40
Curro,Curro Rivonia,10,Accounting,12,2755
Curro,Curro Rivonia,10,Advanced Programme English,2,2755
Curro,Curro Rivonia,10,Advanced Programme Mathematics,9,2755
Curro,Curro Rivonia,10,Afrikaans First Additional Language,47,2755
Curro,Curro Rivonia,10,Business Studies,45,2755
Curro,Curro Rivonia,10,Computer Applications Technology,29,2755
Curro,Curro Rivonia,10,Engineering Graphics and Design,16,2755
Curro,Curro Rivonia,10,English Home Language,70,2755
Curro,Curro Rivonia,10,History,25,2755
Curro,Curro Rivonia,10,Information Technology,19,2755
Curro,Curro Rivonia,10,isiZulu First Additional Language,18,2755
Curro,Curro Rivonia,10,Life Orientation,70,2755
Curro,Curro Rivonia,10,Life Sciences,24,2755
Curro,Curro Rivonia,10,Mathematical Literacy,34,2755
Curro,Curro Rivonia,10,Mathematics,50,2755
Curro,Curro Rivonia,10,Physical Sciences,33,2755
Curro,Curro Rivonia,10,Tourism,23,2755
Curro,Curro Rivonia,10,Visual Arts,12,2755
Curro,Curro Rivonia,11,Accounting,13,2755
Curro,Curro Rivonia,11,Advanced Programme English,4,2755
Curro,Curro Rivonia,11,Advanced Programme Mathematics,7,2755
Curro,Curro Rivonia,11,Afrikaans First Additional Language,51,2755
Curro,Curro Rivonia,11,Business Studies,36,2755
Curro,Curro Rivonia,11,Computer Applications Technology,14,2755
Curro,Curro Rivonia,11,Economics,3,2755
Curro,Curro Rivonia,11,Engineering Graphics and Design,15,2755
Curro,Curro Rivonia,11,English Home Language,69,2755
Curro,Curro Rivonia,11,Geography,3,2755
Curro,Curro Rivonia,11,History,34,2755
Curro,Curro Rivonia,11,Information Technology,10,2755
Curro,Curro Rivonia,11,isiZulu First Additional Language,17,2755
Curro,Curro Rivonia,11,Life Orientation,69,2755
Curro,Curro Rivonia,11,Life Sciences,30,2755
Curro,Curro Rivonia,11,Mathematical Literacy,30,2755
Curro,Curro Rivonia,11,Mathematics,44,2755
Curro,Curro Rivonia,11,Physical Sciences,27,2755
Curro,Curro Rivonia,11,Tourism,33,2755
Curro,Curro Rivonia,11,Visual Arts,5,2755
Curro,Curro Rivonia,12,Accounting,9,2755
Curro,Curro Rivonia,12,Advanced Programme Mathematics,2,2755
Curro,Curro Rivonia,12,Afrikaans First Additional Language,44,2755
Curro,Curro Rivonia,12,Business Studies,31,2755
Curro,Curro Rivonia,12,Computer Applications Technology,16,2755
Curro,Curro Rivonia,12,Economics,7,2755
Curro,Curro Rivonia,12,Engineering Graphics and Design,13,2755
Curro,Curro Rivonia,12,English Home Language,65,2755
Curro,Curro Rivonia,12,French Second Additional Language,2,2755
Curro,Curro Rivonia,12,Geography,8,2755
Curro,Curro Rivonia,12,History,30,2755
Curro,Curro Rivonia,12,Information Technology,5,2755
Curro,Curro Rivonia,12,isiZulu First Additional Language,15,2755
Curro,Curro Rivonia,12,Life Orientation,64,2755
Curro,Curro Rivonia,12,Life Sciences,27,2755
Curro,Curro Rivonia,12,Mathematical Literacy,37,2755
Curro,Curro Rivonia,12,Mathematics,35,2755
Curro,Curro Rivonia,12,Physical Sciences,18,2755
Curro,Curro Rivonia,12,Portuguese Second Additional Language,1,2755
Curro,Curro Rivonia,12,Tourism,19,2755
Curro,Curro Rivonia,12,Visual Arts,13,2755
Curro,Curro Rivonia,8,Afrikaans First Additional Language,59,2755
Curro,Curro Rivonia,8,Business Studies,74,2755
Curro,Curro Rivonia,8,Coding and Robotics ,74,2755
Curro,Curro Rivonia,8,Creative Arts,74,2755
Curro,Curro Rivonia,8,English Home Language,74,2755
Curro,Curro Rivonia,8,isiZulu First Additional Language,15,2755
Curro,Curro Rivonia,8,Life Orientation,74,2755
Curro,Curro Rivonia,8,Mathematics,74,2755
Curro,Curro Rivonia,8,Natural Sciences,74,2755
Curro,Curro Rivonia,8,Social Sciences,74,2755
Curro,Curro Rivonia,9,Accounting,64,2755
Curro,Curro Rivonia,9,Afrikaans First Additional Language,45,2755
Curro,Curro Rivonia,9,Coding and Robotics ,64,2755
Curro,Curro Rivonia,9,Creative Arts,64,2755
Curro,Curro Rivonia,9,English Home Language,64,2755
Curro,Curro Rivonia,9,isiZulu First Additional Language,19,2755
Curro,Curro Rivonia,9,Life Orientation,64,2755
Curro,Curro Rivonia,9,Mathematics,64,2755
Curro,Curro Rivonia,9,Natural Sciences,64,2755
Curro,Curro Rivonia,9,Social Sciences,64,2755`;

        // Initialize
        window.addEventListener('DOMContentLoaded', () => {
            parseCSV(initialCSVData);
            console.log("‚è≥ Waiting for authentication before setting up Firebase listeners...");
            // setupFirebaseListeners() is now called after authentication completes
        });

        // Parse CSV
        function parseCSV(text) {
            const lines = text.trim().split('\n');
            studentData = [];
            
            for (let i = 1; i < lines.length; i++) {
                if (lines[i].trim()) {
                    const parts = lines[i].split(',');
                    if (parts.length >= 6) {
                        studentData.push({
                            brand: parts[0].trim(),
                            school: parts[1].trim(),
                            grade: parseInt(parts[2]),
                            subject: parts[3].trim(),
                            count: parseInt(parts[4]),
                            key: `${parts[2]}-${parts[3].trim()}`
                        });
                    }
                }
            }

            if (studentData.length > 0) {
                document.getElementById('schoolName').textContent = studentData[0].school.toUpperCase();
            }
        }

        // Firebase listeners
        function setupFirebaseListeners() {
            if (!database) {
                renderDashboard();
                return;
            }

            database.ref('studentData').on('value', (snapshot) => {
                if (snapshot.exists()) {
                    studentData = snapshot.val();
                    applyFilters();
                    updateTimestamp();
                }
            });

            database.ref('capacities').on('value', (snapshot) => {
                if (snapshot.exists()) {
                    capacities = snapshot.val();
                    applyFilters();
                }
            });
        }

        function updateTimestamp() {
            document.getElementById('lastUpdated').textContent = 
                `Last Updated: ${new Date().toLocaleString('en-ZA', { 
                    year: 'numeric', 
                    month: 'short', 
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                })}`;
        }

        // Capacity calculation
        function getCapacityInfo(current, max) {
            if (!max || max === 0) {
                return {
                    percentage: 0,
                    class: 'low',
                    label: 'No Limit',
                    width: 0,
                    statusFilter: 'available'
                };
            }

            const percentage = Math.round((current / max) * 100);
            let className, label, statusFilter;

            if (percentage >= 100) {
                className = 'full';
                label = 'Full';
                statusFilter = 'full';
            } else if (percentage >= 71) {
                className = 'high';
                label = 'High';
                statusFilter = 'high';
            } else if (percentage >= 51) {
                className = 'medium';
                label = 'Moderate';
                statusFilter = 'moderate';
            } else {
                className = 'low';
                label = 'Available';
                statusFilter = 'available';
            }

            return {
                percentage: percentage,
                class: className,
                label: label,
                width: Math.min(percentage, 100),
                statusFilter: statusFilter
            };
        }

        // Summary statistics
        function updateSummaryStats() {
            let totalStudents = 0;
            let totalCapacity = 0;
            let available = 0;
            let full = 0;
            let over = 0;
            let noLimit = 0;

            studentData.forEach(item => {
                totalStudents += item.count;
                const capacity = capacities[item.key] || 0;
                
                if (capacity === 0) {
                    noLimit++;
                } else {
                    totalCapacity += capacity;
                    const info = getCapacityInfo(item.count, capacity);
                    
                    if (info.statusFilter === 'over') {
                        over++;
                    } else if (info.statusFilter === 'full') {
                        full++;
                    } else {
                        available++;
                    }
                }
            });

            const overallPercentage = totalCapacity > 0 ? Math.round((totalStudents / totalCapacity) * 100) : 0;

            const statsHtml = `
                <div class="summary-card">
                    <div class="icon">üë•</div>
                    <div class="value">${totalStudents}</div>
                    <div class="label">Total Students</div>
                </div>
                <div class="summary-card">
                    <div class="icon">üìä</div>
                    <div class="value">${overallPercentage}%</div>
                    <div class="label">Overall Capacity</div>
                </div>
                <div class="summary-card">
                    <div class="icon">üü¢</div>
                    <div class="value">${available}</div>
                    <div class="label">Available</div>
                </div>
                <div class="summary-card">
                    <div class="icon">üü°</div>
                    <div class="value">${full}</div>
                    <div class="label">Full Subjects</div>
                </div>
                <div class="summary-card">
                    <div class="icon">üî¥</div>
                    <div class="value">${over}</div>
                    <div class="label">Over Capacity</div>
                </div>
                <div class="summary-card">
                    <div class="icon">‚ö†Ô∏è</div>
                    <div class="value">${noLimit}</div>
                    <div class="label">No Limit Set</div>
                </div>
            `;

            document.getElementById('summaryStats').innerHTML = statsHtml;
        }

        // Filtering
        function applyFilters() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const gradeFilter = document.getElementById('gradeFilter').value;
            const statusFilter = document.getElementById('statusFilter').value;
            const sortFilter = document.getElementById('sortFilter').value;

            // Start with all data
            filteredData = studentData.filter(item => {
                // Grade filter
                if (gradeFilter && item.grade !== parseInt(gradeFilter)) {
                    return false;
                }

                // Search filter
                if (searchTerm && !item.subject.toLowerCase().includes(searchTerm)) {
                    return false;
                }

                // Status filter
                if (statusFilter) {
                    const capacity = capacities[item.key] || 0;
                    const info = getCapacityInfo(item.count, capacity);
                    if (info.statusFilter !== statusFilter) {
                        return false;
                    }
                }

                return true;
            });

            // Sorting
            filteredData.sort((a, b) => {
                const capA = capacities[a.key] || 0;
                const capB = capacities[b.key] || 0;
                const percA = capA > 0 ? (a.count / capA) * 100 : 0;
                const percB = capB > 0 ? (b.count / capB) * 100 : 0;

                switch (sortFilter) {
                    case 'percentage-desc':
                        return percB - percA;
                    case 'percentage-asc':
                        return percA - percB;
                    case 'count-desc':
                        return b.count - a.count;
                    case 'count-asc':
                        return a.count - b.count;
                    case 'name-asc':
                        return a.subject.localeCompare(b.subject);
                    case 'name-desc':
                        return b.subject.localeCompare(a.subject);
                    default:
                        return 0;
                }
            });

            updateSummaryStats();
            renderDashboard();
        }

        // View switching
        function switchView(view) {
            currentView = view;
            
            // Update buttons
            document.querySelectorAll('.view-toggle button').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');

            // Show/hide views
            if (view === 'grid') {
                document.getElementById('gridView').classList.add('grid-view');
                document.getElementById('gridView').classList.remove('table-view');
                document.getElementById('tableView').classList.remove('table-view');
                document.getElementById('tableView').classList.add('table-view');
            } else {
                document.getElementById('gridView').classList.remove('grid-view');
                document.getElementById('gridView').classList.add('table-view');
                document.getElementById('tableView').classList.remove('table-view');
                document.getElementById('tableView').classList.add('grid-view');
            }

            renderDashboard();
        }

        // Render dashboard
        function renderDashboard() {
            if (currentView === 'grid') {
                renderGridView();
            } else {
                renderTableView();
            }
        }

        function renderGridView() {
            const grades = [...new Set(filteredData.map(d => d.grade))].sort((a, b) => b - a); // Sort descending: 12 to 4
            const div = document.getElementById('gridView');

            if (filteredData.length === 0) {
                div.innerHTML = `
                    <div class="empty-state">
                        <div class="icon">üîç</div>
                        <h3>No subjects found</h3>
                        <p>Try adjusting your filters or search terms</p>
                    </div>
                `;
                return;
            }

            div.innerHTML = '';

            grades.forEach(grade => {
                const gradeData = filteredData.filter(d => d.grade === grade);
                
                if (gradeData.length === 0) return;

                // Calculate grade stats
                let gradeAvailable = 0;
                let gradeFull = 0;
                let gradeOver = 0;

                gradeData.forEach(item => {
                    const capacity = capacities[item.key] || 0;
                    if (capacity > 0) {
                        const info = getCapacityInfo(item.count, capacity);
                        if (info.statusFilter === 'over') gradeOver++;
                        else if (info.statusFilter === 'full') gradeFull++;
                        else gradeAvailable++;
                    }
                });

                let html = `<div class="grade-section">
                    <div class="grade-header">
                        <span>Grade ${grade}</span>
                        <div class="grade-stats">
                            <span>üü¢ ${gradeAvailable} Available</span>
                            <span>üü° ${gradeFull} Full</span>
                            <span>üî¥ ${gradeOver} Over</span>
                        </div>
                    </div>
                    <div class="subject-grid">`;

                gradeData.forEach(item => {
                    const capacity = capacities[item.key] || 0;
                    const info = getCapacityInfo(item.count, capacity);

                    html += `
                        <div class="subject-card">
                            <div class="subject-header">
                                <div class="subject-name">${item.subject}</div>
                                <div class="subject-numbers">
                                    <div class="current-number">${item.count}</div>
                                    <div class="max-number">/ ${capacity || '‚Äî'}</div>
                                </div>
                            </div>
                            <div class="capacity-bar-container">
                                <div class="capacity-bar ${info.class}" style="width: ${info.width}%">
                                    ${info.percentage > 0 ? info.percentage + '%' : ''}
                                </div>
                            </div>
                            <div class="status-label ${info.class}">${info.label}</div>
                        </div>
                    `;
                });

                html += `</div></div>`;
                div.innerHTML += html;
            });

            updateTimestamp();
        }

        function renderTableView() {
            const div = document.getElementById('tableView');

            if (filteredData.length === 0) {
                div.innerHTML = `
                    <div class="empty-state">
                        <div class="icon">üîç</div>
                        <h3>No subjects found</h3>
                        <p>Try adjusting your filters or search terms</p>
                    </div>
                `;
                return;
            }

            let html = `
                <div class="subjects-table">
                    <table>
                        <thead>
                            <tr>
                                <th>Grade</th>
                                <th>Subject</th>
                                <th>Current</th>
                                <th>Maximum</th>
                                <th>Available</th>
                                <th>%</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            filteredData.forEach(item => {
                const capacity = capacities[item.key] || 0;
                const info = getCapacityInfo(item.count, capacity);
                const available = capacity > 0 ? Math.max(0, capacity - item.count) : '‚Äî';

                html += `
                    <tr>
                        <td><strong>Grade ${item.grade}</strong></td>
                        <td>${item.subject}</td>
                        <td><span class="table-capacity">${item.count}</span></td>
                        <td>${capacity || '‚Äî'}</td>
                        <td>${available}</td>
                        <td>${info.percentage > 0 ? info.percentage + '%' : '‚Äî'}</td>
                        <td><span class="table-status ${info.statusFilter}">${info.label}</span></td>
                    </tr>
                `;
            });

            html += `</tbody></table></div>`;
            div.innerHTML = html;
            updateTimestamp();
        }

        // Export functions
        function exportToPDF() {
            alert('PDF export would integrate with a library like jsPDF. For now, use Print to PDF from the print dialog.');
            window.print();
        }

        function exportToExcel() {
            let csv = 'Grade,Subject,Current Students,Max Capacity,Available Spots,Percentage,Status\n';
            
            filteredData.forEach(item => {
                const capacity = capacities[item.key] || 0;
                const info = getCapacityInfo(item.count, capacity);
                const available = capacity > 0 ? Math.max(0, capacity - item.count) : 0;
                
                csv += `${item.grade},"${item.subject}",${item.count},${capacity},${available},${info.percentage}%,${info.label}\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `capacity-report-${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>
